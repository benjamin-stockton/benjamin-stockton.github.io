{
  "hash": "0cf1d4d400eb9f544c031c23da7af77c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Longitudinal Models for MLB Careers\"\nauthor: \"Ben Stockton\"\ndate: 2024-02-29\neditor: visual\nformat: \n    html:\n        code-fold: show\n        code-tools: true\n        number-depth: 3\n        toc: true\n        toc-location: left\n        toc-expand: 2\n        toc-depth: 3\n        link-external-newwindow: true\n        citations-hover: true\nbibliography: references.bib\ndraft: true\ncache: true\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(baseballr)\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'dplyr'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(ggplot2)\n\ndat <- lapply(2015:2023, function(yr) {statcast_leaderboards(leaderboard = \"expected_statistics\", year = yr, min_pa = 25)}) |>\n    bind_rows()\n\ndat\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── MLB Baseball Savant Statcast Leaderboards data from baseballsavant.mlb.com ──\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nℹ Data updated: 2024-03-13 14:54:33 EDT\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 7,849 × 14\n    year `last_name, first_name` player_id    pa   bip    ba est_ba\n   <int> <chr>                       <int> <int> <int> <dbl>  <dbl>\n 1  2015 Machado, Manny             592518   713   528 0.286  0.267\n 2  2015 Donaldson, Josh            518626   711   499 0.297  0.279\n 3  2015 Dozier, Brian              572821   704   488 0.236  0.22 \n 4  2015 Rizzo, Anthony             519203   701   488 0.278  0.275\n 5  2015 Votto, Joey                458015   695   412 0.314  0.289\n 6  2015 Goldschmidt, Paul          502671   694   423 0.321  0.279\n 7  2015 Fielder, Prince            425902   693   530 0.305  0.277\n 8  2015 Fowler, Dexter             451594   690   447 0.25   0.231\n 9  2015 Eaton, Adam                594809   689   486 0.287  0.251\n10  2015 Altuve, Jose               514888   689   580 0.313  0.262\n# ℹ 7,839 more rows\n# ℹ 7 more variables: est_ba_minus_ba_diff <dbl>, slg <dbl>, est_slg <dbl>,\n#   est_slg_minus_slg_diff <dbl>, woba <dbl>, est_woba <dbl>,\n#   est_woba_minus_woba_diff <dbl>\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndat |>\n    filter(\n        pa >= 100\n    ) |>\n    ggplot(aes(woba, est_woba, color = est_woba_minus_woba_diff, alpha = 1 - 1/pa)) +\n        geom_point() +\n        geom_abline(slope = 1, color = \"red\", linetype = \"dashed\")\n```\n\n::: {.cell-output-display}\n![](longitudinal-models-careers_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntop_batters <- dat |>\n    group_by(player_id, `last_name, first_name`) |>\n    summarize(\n        total_pa = sum(pa)\n    ) |>\n    arrange(desc(total_pa)) |>\n    head(25)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`summarise()` has grouped output by 'player_id'. You can override using the\n`.groups` argument.\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndat <- dat |>\n    mutate(\n        t = year - 2016,\n        tsq = (t - 3.5)^2,\n        woba_l1 = lag(woba)\n    )\n\ndat2 <- left_join(top_batters, dat, by = c(\"player_id\", \"last_name, first_name\"))\n\ns <- sample(length(unique(dat$player_id)), size = floor(length(unique(dat$player_id)) * 0.75))\ndat_train <- dat |>\n    filter(\n        # player_id %in% top_batters$player_id[s],\n        year >= 2016,\n        pa >= 150\n    )\n\ndat_test <- dat |>\n    filter(\n        # player_id %in% top_batters$player_id[-s],\n        year >= 2016,\n        pa >= 150\n    )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndat2 |>\n    ggplot(aes(year, est_woba)) +\n        geom_point() +\n        geom_smooth(method = \"lm\", se = FALSE) +\n        facet_wrap(player_id~.) +\n        theme(axis.text.x = element_text(angle = 45, hjust = 1))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](longitudinal-models-careers_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(lme4)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: Matrix\n```\n\n\n:::\n\n```{.r .cell-code}\nfit1 <- lmer(woba ~ woba_l1 + est_woba + (t | player_id), data = dat_train)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in checkConv(attr(opt, \"derivs\"), opt$par, ctrl = control$checkConv, :\nModel failed to converge with max|grad| = 0.0021491 (tol = 0.002, component 1)\n```\n\n\n:::\n\n```{.r .cell-code}\nfit3 <- lmer(woba ~ woba_l1 + est_woba + (t + tsq | player_id), data = dat_train)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in checkConv(attr(opt, \"derivs\"), opt$par, ctrl = control$checkConv, :\nModel failed to converge with max|grad| = 0.00944676 (tol = 0.002, component 1)\n```\n\n\n:::\n\n```{.r .cell-code}\n# fit4 <- lmer(woba ~ woba_l1 + (splines::bs(t) | player_id), data = dat_train)\n\nsummary(fit3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLinear mixed model fit by REML ['lmerMod']\nFormula: woba ~ woba_l1 + est_woba + (t + tsq | player_id)\n   Data: dat_train\n\nREML criterion at convergence: -14742.4\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-3.5923 -0.6071 -0.0051  0.6133  6.0905 \n\nRandom effects:\n Groups    Name        Variance  Std.Dev.  Corr       \n player_id (Intercept) 1.848e-04 0.0135928            \n           t           3.739e-06 0.0019337 -0.80      \n           tsq         2.439e-07 0.0004939 -0.70  0.44\n Residual              3.742e-04 0.0193450            \nNumber of obs: 3021, groups:  player_id, 921\n\nFixed effects:\n            Estimate Std. Error t value\n(Intercept) 0.024436   0.004063   6.013\nwoba_l1     0.027049   0.008659   3.124\nest_woba    0.896887   0.011213  79.986\n\nCorrelation of Fixed Effects:\n         (Intr) wob_l1\nwoba_l1  -0.511       \nest_woba -0.742 -0.187\noptimizer (nloptwrap) convergence code: 0 (OK)\nModel failed to converge with max|grad| = 0.00944676 (tol = 0.002, component 1)\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nAIC(fit1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] -14723.03\n```\n\n\n:::\n\n```{.r .cell-code}\nAIC(fit3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] -14722.37\n```\n\n\n:::\n\n```{.r .cell-code}\n# AIC(fit4)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(lattice)\ndotplot(ranef(fit3))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$player_id\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](longitudinal-models-careers_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(fit3)\n```\n\n::: {.cell-output-display}\n![](longitudinal-models-careers_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Predict on training set\npreds  <- merTools::predictInterval(fit3, newdata = dat_train, n.sims = 100, returnSims = TRUE, seed = 657, level = 0.95) %>%\n  as.data.frame()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in merTools::predictInterval(fit3, newdata = dat_train, n.sims = 100, : newdata is tbl_df or tbl object from dplyr package and has been\n              coerced to a data.frame\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: executing %dopar% sequentially: no parallel backend registered\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n\nWarning in rnorm(N, yhat[, x], sigmahat[x]): NAs produced\n```\n\n\n:::\n\n```{.r .cell-code}\ndat3 <- bind_cols(dat_train, preds)\n \ndat3$group <- \"train\"\n \n# Predict on test set with 90% prediction intervals\ntest_preds  <- merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, returnSims = TRUE, seed = 657, level = 0.95) %>%\n  as.data.frame()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : newdata is tbl_df or tbl object from dplyr package and has been\n              coerced to a data.frame\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n\nWarning in merTools::predictInterval(fit3, newdata = dat_test, n.sims = 100, : NAs produced\n```\n\n\n:::\n\n```{.r .cell-code}\ndat4 <- bind_cols(dat_test, test_preds)\n\ndat4$group <- \"test\"\n\n# Combine the data together\ncombined_dat <- bind_rows(dat3, dat4) %>%\n  arrange(player_id)\n\n## Plot the time series of predictions and observed data\ncombined_dat |>\n    filter(\n        player_id %in% top_batters$player_id\n    ) |>\n    mutate(group = factor(group, levels = c(\"train\", \"test\"))) |>\n    ggplot(aes(x = t, y = woba)) +\n      geom_ribbon(aes(ymin = lwr,\n                      ymax = upr),\n                  fill = \"light grey\",\n                  alpha = 0.8) +\n      geom_line(aes(y = fit),\n                col = \"red\",\n                size = 1) +\n      geom_point(aes(fill = group),\n                 size = 3,\n                 shape = 21) +\n      geom_line() +\n      facet_wrap(~player_id) +\n      theme(strip.background = element_rect(fill = \"black\"),\n            strip.text = element_text(face = \"bold\", color = \"white\"),\n            legend.position = \"right\") +\n      labs(x = \"t\",\n           y = \"wOBA\",\n           title = \"wOBA over 2016-2023\") +\n      theme_bw()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.\nℹ Please use `linewidth` instead.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](longitudinal-models-careers_files/figure-html/fig-fitted-lmm-1.png){#fig-fitted-lmm width=576}\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}