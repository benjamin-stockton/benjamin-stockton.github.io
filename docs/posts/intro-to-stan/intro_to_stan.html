<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ben Stockton">
<meta name="dcterms.date" content="2023-11-16">

<title>Getting to know Stan - SWOSC – Ben Stockton’s Stats Site</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-79738a6259eca0376d8e1d15bd672c3c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Getting to know Stan - SWOSC – Ben Stockton’s Stats Site">
<meta property="og:description" content="">
<meta property="og:image" content="https://benjamin-stockton.github.io/posts/intro-to-stan/stan_logo.png">
<meta property="og:site_name" content="Ben Stockton's Stats Site">
<meta property="og:image:height" content="376">
<meta property="og:image:width" content="375">
<meta name="twitter:title" content="Getting to know Stan - SWOSC – Ben Stockton’s Stats Site">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://benjamin-stockton.github.io/posts/intro-to-stan/stan_logo.png">
<meta name="twitter:image-height" content="376">
<meta name="twitter:image-width" content="375">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Ben Stockton’s Stats Site</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/benjamin-stockton"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://linkedin.com/in/benjamin-stockton-329507160/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Getting to know Stan - SWOSC</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                                <div class="quarto-categories">
                <div class="quarto-category">bayesian-analysis</div>
                <div class="quarto-category">computation</div>
                <div class="quarto-category">tutorial</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Ben Stockton </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 16, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#installation" id="toc-installation" class="nav-link active" data-scroll-target="#installation">Installation</a></li>
  <li><a href="#a-very-brief-introduction-to-bayesian-data-analysis" id="toc-a-very-brief-introduction-to-bayesian-data-analysis" class="nav-link" data-scroll-target="#a-very-brief-introduction-to-bayesian-data-analysis">A Very Brief Introduction to Bayesian Data Analysis</a></li>
  <li><a href="#why-stan" id="toc-why-stan" class="nav-link" data-scroll-target="#why-stan">Why Stan?</a></li>
  <li><a href="#some-examples-in-stan" id="toc-some-examples-in-stan" class="nav-link" data-scroll-target="#some-examples-in-stan">Some examples in Stan</a>
  <ul class="collapse">
  <li><a href="#non-informative-prior-regression-model" id="toc-non-informative-prior-regression-model" class="nav-link" data-scroll-target="#non-informative-prior-regression-model">Non-informative Prior Regression Model</a></li>
  <li><a href="#conjugate-prior-regression-model" id="toc-conjugate-prior-regression-model" class="nav-link" data-scroll-target="#conjugate-prior-regression-model">Conjugate Prior Regression Model</a></li>
  </ul></li>
  <li><a href="#some-other-useful-resources-for-stan" id="toc-some-other-useful-resources-for-stan" class="nav-link" data-scroll-target="#some-other-useful-resources-for-stan">Some Other Useful Resources for Stan</a></li>
  <li><a href="#bonus-regression-modeling-with-incomplete-data" id="toc-bonus-regression-modeling-with-incomplete-data" class="nav-link" data-scroll-target="#bonus-regression-modeling-with-incomplete-data">Bonus: Regression Modeling with Incomplete Data</a>
  <ul class="collapse">
  <li><a href="#multiple-imputation-with-mice" id="toc-multiple-imputation-with-mice" class="nav-link" data-scroll-target="#multiple-imputation-with-mice">Multiple Imputation with mice</a></li>
  <li><a href="#imputation-during-model-fitting" id="toc-imputation-during-model-fitting" class="nav-link" data-scroll-target="#imputation-during-model-fitting">Imputation During Model Fitting</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/benjamin-stockton/benjamin-stockton.github.io/edit/main/posts/intro-to-stan/intro_to_stan.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/benjamin-stockton/benjamin-stockton.github.io/blob/main/posts/intro-to-stan/intro_to_stan.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li><li><a href="https://github.com/benjamin-stockton/benjamin-stockton.github.io/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p><img src="stan_logo.png" class="img-fluid"></p>
<section id="installation" class="level2">
<h2 class="anchored" data-anchor-id="installation">Installation</h2>
<p>To get started, we’ll head over to Stan’s <a href="https://mc-stan.org/">documentation</a> to see how to get set up in R. For this presentation, I’ll use the CmdStan toolchain that’s implemented in R by the <code>cmdstanr</code> <a href="https://mc-stan.org/cmdstanr/">package</a> <span class="citation" data-cites="gabry2023">(<a href="#ref-gabry2023" role="doc-biblioref">Gabry, Češnovar, and Johnson 2023</a>)</span>. There are also Python, command line, Matlab, Julia, and Stata interfaces to Stan and a Python interface for cmdstan called <a href="https://github.com/stan-dev/cmdstanpy">CmdStanPy</a> <span class="citation" data-cites="cmdstanp">(<a href="#ref-cmdstanp" role="doc-biblioref"><span>“Cmdstanpy <span></span> Python Interface to CmdStan <span></span> CmdStanPy 1.1.0 Documentation,”</span> n.d.</a>)</span>.</p>
<div class="cell">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">98463</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is cmdstanr version 0.6.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStanR documentation and vignettes: mc-stan.org/cmdstanr</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStan path: C:/Users/stocb/OneDrive/Documents/.cmdstan/cmdstan-2.33.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStan version: 2.33.1</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cmdstanr::install_cmdstan()</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>cmdstanr<span class="sc">::</span><span class="fu">cmdstan_version</span>()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>cmdstanr<span class="sc">::</span><span class="fu">cmdstan_path</span>()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>cmdstanr<span class="sc">::</span><span class="fu">check_cmdstan_toolchain</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>The C++ toolchain required for CmdStan is setup properly!</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(c("bayesplot", "ggplot2", "posterior"))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2.33.1"
[1] "C:/Users/stocb/OneDrive/Documents/.cmdstan/cmdstan-2.33.1"</code></pre>
</div>
</div>
</section>
<section id="a-very-brief-introduction-to-bayesian-data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="a-very-brief-introduction-to-bayesian-data-analysis">A Very Brief Introduction to Bayesian Data Analysis</h2>
<p>The broadest conceptual overview of Bayesian data analysis is that this methodology allows us to incorporate prior knowledge about the model/data into our analysis which is based on a posterior distribution that is derived from the prior and likelihood. Bayesian inference treats the parameters of the model as random variables whose distribution we are interested in either deriving analytically or approximating through computation. This is a key distinction from frequentist methods taught in math stat and applied stat where parameters are fixed values and their estimators are functions of a random sample and the sampling distribution of the estimator is used for inference.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Bayes Rule
</div>
</div>
<div class="callout-body-container callout-body">
<p>A quick reminder of Bayes Rule.</p>
<p>Let <span class="math inline">\(\theta\)</span> be a random variable with (prior) distribution <span class="math inline">\(p(\theta)\)</span>, <span class="math inline">\(Y\)</span> be a random variable that depends on <span class="math inline">\(\theta\)</span> with conditional distribution or likelihood <span class="math inline">\(p(y | \theta)\)</span>. Then their joint distribution is <span class="math inline">\(p(y, \theta) = p(y|\theta) p(\theta)\)</span>.</p>
<p>Bayes rule lets us flip the conditioning from the likelihood to get <span class="math inline">\(p(\theta | y)\)</span></p>
<p><span class="math display">\[
p(\theta | y) = \frac{p(y, \theta)}{p(y)} = \frac{p(y|\theta) p(\theta)}{\int p(y, \theta) d\theta} \propto p(y|\theta) p(\theta)
\]</span></p>
</div>
</div>
<p>To be a little more specific, we have three central components to the model. For ease of exposition, let’s consider the simple regression model <span class="math inline">\(E(Y_i | X_i = x_i, \boldsymbol{\beta}, \sigma^2) = \beta_0 + \beta_1 X_i\)</span> and <span class="math inline">\(Var(Y_i | X_i = x_i, \boldsymbol{\beta}, \sigma^2) = \sigma^2\)</span> where we have <span class="math inline">\(i = 1,\dots,N\)</span> observations of <span class="math inline">\((Y_i, X_i)'\)</span> from Ch. 14 of Bayesian Data Analysis <span class="citation" data-cites="gelman2013bayesian">(<a href="#ref-gelman2013bayesian" role="doc-biblioref">Gelman et al. 2013, 354–58</a>)</span>. From here on I will suppress conditioning on the observed predictor <span class="math inline">\(X_i = x_i\)</span> since we are considering the design matrix <span class="math inline">\(X = (1_N, \mathbf{x})\)</span> to be fixed and known where <span class="math inline">\(\mathbf{x} = (x_1,\dots, x_N)'\)</span>.</p>
<ol type="1">
<li><strong>The Prior:</strong> a distribution for the parameters that doesn’t depend on the data <span class="math inline">\(p(\theta)\)</span>.</li>
<li><strong>The (Data) Likelihood:</strong> a model for the data that depends on the parameters <span class="math inline">\(p(y | \theta)\)</span>.</li>
<li><strong>The Posterior:</strong> a distribution that uses Bayes rule to define distribution of the parameters given the data <span class="math inline">\(p(\theta|y)\)</span>.</li>
</ol>
</section>
<section id="why-stan" class="level2">
<h2 class="anchored" data-anchor-id="why-stan">Why Stan?</h2>
<ul>
<li><p>Stan is one of several ways to run MCMC for Bayesian inference</p>
<ul>
<li>Nimble and OpenBUGS are two other languages dedicated to probabilistic programming</li>
<li>R, Rcpp, Julia, and Python are other more general purpose options for writing the sampler from scratch</li>
</ul></li>
<li><p>Other methods use combinations of Gibbs, Metropolis-Hastings, and slice sampling; Stan uses Hamiltonian Monte Carlo and the No-U-Turn Sampler (NUTS) which is more efficient and typically requires less thinning</p></li>
<li><p>Stan only allows for continuous parameters</p></li>
</ul>
</section>
<section id="some-examples-in-stan" class="level2">
<h2 class="anchored" data-anchor-id="some-examples-in-stan">Some examples in Stan</h2>
<p>We’ll continue with the single predictor regression model to model NCAA Women’s Basketball team’s total wins by their 3 point field goal percentage from the 2022-2023 season. Data collected from <a href="https://stats.ncaa.org/rankings?sport_code=WBB&amp;division=2">NCAA</a>.</p>
<div class="cell">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>ncaaw <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="at">file =</span> <span class="st">"Data/NCAAW-freethrows-threes-2022-2023.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 350 Columns: 11
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (2): Team, WL
dbl (9): G, FT, FTA, FTpct, FG3, FG3A, FG3pct, W, L

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<p>In the 2022-2023 season there were <span class="math inline">\(N = 350\)</span> teams. The relationship between their wins and three point percentage is displayed in <a href="#fig-scatter" class="quarto-xref">Figure&nbsp;1</a>.</p>
<div class="cell">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ncaaw, <span class="fu">aes</span>(FG3pct, W)) <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"2022-23 NCAAW Wins by 3pt%"</span>, </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"r = "</span>, <span class="fu">round</span>(<span class="fu">cor</span>(ncaaw<span class="sc">$</span>W, ncaaw<span class="sc">$</span>FG3pct), <span class="dv">3</span>)),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"3pt%"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Wins"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell-output-display">
<div id="fig-scatter" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-scatter-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Scatter plot of the Total Wins by 3 pt Field Goal %.
</figcaption>
</figure>
</div>
</div>
</div>
<p>As a baseline, we’ll find the maximum likelihood estimates for the regression parameters and variance.</p>
<div class="cell">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fit_ml <span class="ot">&lt;-</span> <span class="fu">lm</span>(W <span class="sc">~</span> FG3pct, <span class="at">data =</span> ncaaw)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>(beta_ml <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit_ml))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>smry_ml <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit_ml)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>(sigma_ml <span class="ot">&lt;-</span> smry_ml<span class="sc">$</span>sigma)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>mles <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameters =</span> <span class="fu">c</span>(<span class="st">"beta_0"</span>, <span class="st">"beta_1"</span>, <span class="st">"sigma"</span>),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">Estimates =</span> <span class="fu">c</span>(beta_ml, sigma_ml))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)      FG3pct 
  -14.94468     1.00929 
[1] 5.908144</code></pre>
</div>
</div>
<p>The fitted line is displayed in <a href="#fig-scatter-ols" class="quarto-xref">Figure&nbsp;2</a>.</p>
<div class="cell">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ncaaw, <span class="fu">aes</span>(FG3pct, W)) <span class="sc">+</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"2022-23 NCAAW Wins by 3pt%"</span>, </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"r = "</span>, <span class="fu">round</span>(<span class="fu">cor</span>(ncaaw<span class="sc">$</span>W, ncaaw<span class="sc">$</span>FG3pct), <span class="dv">3</span>)),</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"3pt%"</span>,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Wins"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-scatter-ols" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-ols-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-scatter-ols-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-ols-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Now the OLS regression line is super-imposed in blue.
</figcaption>
</figure>
</div>
</div>
</div>
<section id="non-informative-prior-regression-model" class="level3">
<h3 class="anchored" data-anchor-id="non-informative-prior-regression-model">Non-informative Prior Regression Model</h3>
<p>Let’s consider the simple regression model <span class="math inline">\(E(Y_i | X_i, \boldsymbol{\beta}, \sigma^2) = \beta_0 + \beta_1 X_i\)</span> and <span class="math inline">\(Var(Y_i | X_i = x_i, \boldsymbol{\beta}, \sigma^2) = \sigma^2\)</span> <span class="citation" data-cites="gelman2013bayesian">(<a href="#ref-gelman2013bayesian" role="doc-biblioref">Gelman et al. 2013, 354–58</a>)</span>.</p>
<ol type="1">
<li><strong>The Prior:</strong> <span class="math inline">\(p(\boldsymbol{\beta}, \log\sigma) = 1 \equiv p(\boldsymbol{\beta}, \sigma^2) \propto \sigma^{-2}\)</span></li>
<li><strong>The (Data) Likelihood:</strong> <span class="math inline">\(\mathbf{Y} | \boldsymbol{\beta}, \sigma^2 \sim N_N(X\boldsymbol{\beta}, \sigma^2 I_N).\)</span></li>
<li><strong>The Posterior:</strong></li>
</ol>
<span class="math display">\[\begin{align*}
    p(\boldsymbol{\beta}, \sigma^2 | \mathbf{y}) &amp;= p(\boldsymbol{\beta} | \sigma^2, \mathbf{y}) \times p(\sigma^2 | \mathbf{y}) \\
        &amp;= N_2(\boldsymbol{\beta} | \hat{\boldsymbol{\beta}}, \sigma^2 (X'X)^{-1}) \times Inv-\chi^2 (\sigma^2 | N-2, s^2) \\
    \hat{\boldsymbol{\beta}} &amp;= (X'X)^{-1} X'\mathbf{y} \\
    s^2 &amp;= \frac{1}{N-2} (\mathbf{y} - X\hat{\boldsymbol{\beta}})' (\mathbf{y} - X\hat{\boldsymbol{\beta}})   
\end{align*}\]</span>
<p>First we write the Stan code in a separate file. See the <a href="https://mc-stan.org/docs/stan-users-guide/linear-regression.html#vectorization.section">Stan User’s Guide Part 1.1</a> for programming this model without the analytic posteriors. (<a href="non-informative-regression.stan" target="_blank">Download the file here</a>)</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>non-informative-regression.stan</strong></pre>
</div>
<div class="sourceCode" id="cb17" data-filename="non-informative-regression.stan"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">// The input data is two vectors 'y' and 'X' of length 'N'.</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; N;</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] y;</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] x;</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed data</span> {</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">matrix</span>[N, <span class="dv">2</span>] X_c = append_col(rep_vector(<span class="dv">1</span>, N), x);</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">matrix</span>[<span class="dv">2</span>,<span class="dv">2</span>] XtX_inv = inverse(X_c' * X_c);</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vector</span>[<span class="dv">2</span>] beta_hat = XtX_inv * X_c' * y;</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vector</span>[N] y_hat = X_C * beta_hat;</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; s_2 = <span class="dv">1</span> / (N - <span class="dv">2</span>) * (y - y_hat)' * (y - y_hat);</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co">// The parameters accepted by the model. Our model</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="co">// accepts two parameters 'beta' and 'sigma'.</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span> beta;</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma; <span class="co">// Note that this is the variance</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="co">// The model to be estimated. We model the output</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="co">// 'y' ~ N(x beta, sigma) by specifying the analytic</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="co">// posterior defined above.</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  beta ~ multi_normal(beta_hat, sigma^<span class="dv">2</span> * XtX_inv);</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>  sigma^<span class="dv">2</span> ~ scaled_inv_chi_square(N<span class="dv">-2</span>, sqrt(s_2));</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a><span class="kw">generated quantities</span> {</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vector</span>[N] y_ppd;</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>        y_ppd[i] = normal_rng(X_c[i,] * beta, sigma);</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we fit the model using <code>cmdstanr</code>. In this case, I will use 1000 warmup iterations, 1000 sampling iterations, with no thinning (thinning includes only every <span class="math inline">\(k\)</span>th draw), and will refresh the print screen to see progress every 500 iterations. We can run several chains to see if where the chains start dictates any part of the posterior shape or location, and chains can be run in parallel to get more draws &lt;=&gt; better posterior approximation more quickly.</p>
<div class="cell">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>data_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> <span class="fu">nrow</span>(ncaaw),</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> ncaaw<span class="sc">$</span>W,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> ncaaw<span class="sc">$</span>FG3pct</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"non-informative-regression.stan"</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>non_inf_model <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(file)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> non_inf_model<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_list,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter_sampling =</span> <span class="dv">1000</span>,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> <span class="dv">1</span>,</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">500</span>,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_messages =</span> <span class="cn">TRUE</span>,</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_exceptions =</span> <span class="cn">FALSE</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 2 sequential chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 0.3 seconds.
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 0.4 seconds.

Both chains finished successfully.
Mean chain execution time: 0.4 seconds.
Total execution time: 0.9 seconds.</code></pre>
</div>
</div>
<p>Next we’ll check diagnostics for the sampler. First, we will look at the numeric diagnostic output from the method <code>$diagnostic_summary()</code> which reports if any transitions were divergent, if maximum tree depth was reached, and EBFMI. For this model and data set we don’t see any issues in these summaries.</p>
<p>Next, we check the traceplots in <a href="#fig-traceplots-non-info-1" class="quarto-xref">Figure&nbsp;3 (a)</a>. The MCMC draws can be collected from the <code>fit</code> object using the <code>$draws()</code> method. These plots display the sampled values for each parameter in a line plot. We are looking for a horizontal fuzzy bar. Then we can also look at density plots in <a href="#fig-traceplots-non-info-2" class="quarto-xref">Figure&nbsp;3 (b)</a> which will tell us if the chains reached reasonably similar densities. On both counts, we are in good shape. The plots are created using the <code>bayesplot</code> package.</p>
<div class="cell">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fit1<span class="sc">$</span><span class="fu">diagnostic_summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$num_divergent
[1] 0 0

$num_max_treedepth
[1] 0 0

$ebfmi
[1] 1.158355 1.007918</code></pre>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is bayesplot version 1.10.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- Online documentation and vignettes at mc-stan.org/bayesplot</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- bayesplot theme set to bayesplot::theme_default()</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>   * Does _not_ affect other ggplot2 plots</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>   * See ?bayesplot_theme_set for details on theme setting</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(fit1<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"sigma"</span>)))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_dens_overlay</span>(fit1<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"sigma"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-traceplots-non-info" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-traceplots-non-info-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-traceplots-non-info" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-traceplots-non-info-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-traceplots-non-info-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-traceplots-non-info-1.png" class="img-fluid figure-img" data-ref-parent="fig-traceplots-non-info" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-traceplots-non-info-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Traceplots for <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span>.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-traceplots-non-info" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-traceplots-non-info-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-traceplots-non-info-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-traceplots-non-info-2.png" class="img-fluid figure-img" data-ref-parent="fig-traceplots-non-info" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-traceplots-non-info-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Approximate posterior densities for <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span>.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-traceplots-non-info-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Diagnostic plots for the posterior samples. Plots were made using the <code>bayesplot</code> package.
</figcaption>
</figure>
</div>
<p>Finally, after checking that the MCMC chains and diagnostics look satisfactory, we can continue to inference. The summary statistics for the parameters are displayed in <a href="#tbl-non-info-inf" class="quarto-xref">Table&nbsp;1</a>. This are generated by default with the <code>$summary()</code> method. The statistics include the posterior mean (<code>mean</code>), median (<code>median</code>), standard deviation (<code>sd</code>), mean absolute deviation (<code>mad</code>), and lower (<code>q5</code>) and upper bounds (<code>q95</code>) for a 90% credible interval. The statistics <code>rhat</code>, <code>ess_bulk</code>, and <code>ess_tail</code> are additional diagnostic measures that indicate how well the chains are sampling the posterior and how many effective draws we have made. Ideally <code>rhat</code> is very near 1, even 1.01 can be a significant problem. The effective sample sizes should be large/near the number of sampling iterations.</p>
<div class="cell">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>fit1<span class="sc">$</span><span class="fu">summary</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"sigma"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>, <span class="at">format =</span> <span class="st">"html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="tbl-non-info-inf" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-non-info-inf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Summary statistics for the posterior samples for <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span>.
</figcaption>
<div aria-describedby="tbl-non-info-inf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">median</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mad</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q95</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rhat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_bulk</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">beta[1]</td>
<td style="text-align: right;">-15.170201</td>
<td style="text-align: right;">-15.17435</td>
<td style="text-align: right;">2.7264741</td>
<td style="text-align: right;">2.6386574</td>
<td style="text-align: right;">-19.6968650</td>
<td style="text-align: right;">-10.670060</td>
<td style="text-align: right;">1.003857</td>
<td style="text-align: right;">600.4229</td>
<td style="text-align: right;">668.3881</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[2]</td>
<td style="text-align: right;">1.016536</td>
<td style="text-align: right;">1.01743</td>
<td style="text-align: right;">0.0876394</td>
<td style="text-align: right;">0.0866691</td>
<td style="text-align: right;">0.8718595</td>
<td style="text-align: right;">1.159618</td>
<td style="text-align: right;">1.004031</td>
<td style="text-align: right;">596.0433</td>
<td style="text-align: right;">630.5212</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">5.927539</td>
<td style="text-align: right;">5.92005</td>
<td style="text-align: right;">0.2185852</td>
<td style="text-align: right;">0.2262596</td>
<td style="text-align: right;">5.5846900</td>
<td style="text-align: right;">6.297106</td>
<td style="text-align: right;">1.001305</td>
<td style="text-align: right;">862.2062</td>
<td style="text-align: right;">822.5273</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
<div class="cell" data-output-location="column-fragment">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>mles <span class="sc">|&gt;</span> </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>, </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">format =</span> <span class="st">"html"</span>, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="tbl-mle-res-1" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-output-location="column-fragment">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-mle-res-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: MLE estimates for <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span>.
</figcaption>
<div aria-describedby="tbl-mle-res-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Parameters</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Estimates</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: left;">beta_0</td>
<td style="text-align: right;">-14.945</td>
</tr>
<tr class="even">
<td style="text-align: left;">FG3pct</td>
<td style="text-align: left;">beta_1</td>
<td style="text-align: right;">1.009</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">5.908</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
<p>We can also check graphical summaries of this same information such as interval plots for each parameter’s credible intervals or density/area plots. In <a href="#fig-non-info-ci-1" class="quarto-xref">Figure&nbsp;4 (a)</a> we have the 50% (thick bar) and 95% (thin bar) credible intervals with the posterior mean displayed as a point. The densities are plotted in ridgelines in <a href="#fig-non-info-ci-2" class="quarto-xref">Figure&nbsp;4 (b)</a> with areas shaded underneath to indicate the 50% interval and the width of the density indicates the 95% interval.</p>
<div id="fig-non-info-ci" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-non-info-ci-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_intervals</span>(fit1<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"sigma"</span>)))</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas_ridges</span>(fit1<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"sigma"</span>)),</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prob_outer =</span> <span class="fl">0.95</span>, <span class="at">prob =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-non-info-ci" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-non-info-ci-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-non-info-ci-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-non-info-ci-1.png" class="img-fluid figure-img" data-ref-parent="fig-non-info-ci" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-non-info-ci-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Interval plots for <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span>.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-non-info-ci" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-non-info-ci-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-non-info-ci-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-non-info-ci-2.png" class="img-fluid figure-img" data-ref-parent="fig-non-info-ci" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-non-info-ci-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Approximate posterior densities for <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span> in a ridgeline plot.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-non-info-ci-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Plots for the 50% Credible Interval (inner band) and 95% Credible Interval (outer band) for <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span>. Plots were made using the <code>bayesplot</code> package.
</figcaption>
</figure>
</div>
<p>One additional way to check model fit is to assess posterior predictive checks. To do so we draw samples from the posterior predictive distribution <span class="math inline">\(p(y^{new} | y) = \int p(y^{new} | \boldsymbol{\beta}, \sigma) p(\boldsymbol{\beta}, \sigma | y) d\boldsymbol{\beta}d\sigma\)</span> by first sampling from the posterior (i.e.&nbsp;the draws in the MCMC chains) and then for each set of draws sampling <span class="math inline">\(y^{new}\)</span> given the corresponding values for <span class="math inline">\(x^{new}\)</span>. In Stan this is easily accomplished using the generated quantities block. The generated quantities block generates new samples that we define using the current iteration’s posterior draws of <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span>.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">generated quantities</span> {</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// create a vector of N new observations</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vector</span>[N] y_ppd; </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// for each observation, sample from the regression likelihod</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// using the posterior draws</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        y_ppd[i] = normal_rng(X_c[i,] * beta, sigma);</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We collect the PPD draws from the fit object using the draws method. From <a href="#fig-non-info-ppc" class="quarto-xref">Figure&nbsp;5</a> we can see that while the predictive densities are centered in the correct location, the variances are far too large.</p>
<div class="cell-output cell-output-stderr">
<pre><code>This is posterior version 1.5.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'posterior'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:bayesplot':

    rhat</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    mad, sd, var</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    %in%, match</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>y_ppd <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">as_draws_df</span>(fit1<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="st">"y_ppd"</span>)))</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ppc_dens_overlay</span>(ncaaw<span class="sc">$</span>W,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>                 y_ppd[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">350</span>]) <span class="sc">+</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Density of PPD Draws of NCAAW Wins"</span>,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Wins"</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ppc_intervals</span>(ncaaw<span class="sc">$</span>W,</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>                 y_ppd[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">350</span>],</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">x =</span> ncaaw<span class="sc">$</span>FG3pct) <span class="sc">+</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Density of PPD Draws of NCAAW Wins by 3pt%"</span>,</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"3pt%"</span>,</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Wins"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-non-info-ppc" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-non-info-ppc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-non-info-ppc" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-non-info-ppc-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-non-info-ppc-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-non-info-ppc-1.png" class="img-fluid figure-img" data-ref-parent="fig-non-info-ppc" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-non-info-ppc-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) PPD densities for the wins given 3pt%.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-non-info-ppc" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-non-info-ppc-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-non-info-ppc-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-non-info-ppc-2.png" class="img-fluid figure-img" data-ref-parent="fig-non-info-ppc" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-non-info-ppc-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) PPD intervals for the wins plotted by 3pt%.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-non-info-ppc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Posterior Predictive Check plots from <code>bayesplot</code>.
</figcaption>
</figure>
</div>
</section>
<section id="conjugate-prior-regression-model" class="level3">
<h3 class="anchored" data-anchor-id="conjugate-prior-regression-model">Conjugate Prior Regression Model</h3>
<p>Next, we’ll implement the regression model with conjugate priors. Conjugacy refers to the situation where the prior and posterior distribution are from the same family. We’ll start by re-defining our model.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<ol type="1">
<li><p><strong>Conjugate prior:</strong> <span class="math inline">\(p(\boldsymbol{\beta}, \sigma^2) = p(\boldsymbol{\beta} | \sigma^2) p(\sigma^2)\)</span></p>
<ol type="1">
<li><p><span class="math inline">\(\boldsymbol{\beta} | \sigma^2 ~ N_2(\boldsymbol{\beta}_0, \sigma^2 \Lambda_0^{-1})\)</span> where <span class="math inline">\(\boldsymbol{\beta}_0 \in \mathbb{R}^2\)</span> is a vector of prior coefficients, we’ll set it to zero, and <span class="math inline">\(\Lambda_0\)</span> is a <span class="math inline">\(2\times2\)</span> prior correlation matrix. We will set <span class="math inline">\(\Lambda_0 = 10 I_2\)</span> to get a weakly informative prior that is equivalent to ridge regression.</p></li>
<li><p><span class="math inline">\(\sigma^2 \sim InvGamma(\frac{\nu_0}{2}, \frac{1}{2} \nu_0 s_0^2)\)</span> where <span class="math inline">\(\nu_0\)</span> is a prior sample size and <span class="math inline">\(s_0\)</span> is the prior standard deviation. We’ll set these to <span class="math inline">\(\nu_0 = 1\)</span> and <span class="math inline">\(s_0^2 = 47\)</span> which is approximately the sample variance of the NCAA women’s basketball teams’ wins.</p></li>
<li><p>The parameters <span class="math inline">\(\boldsymbol{\beta}_0, \Lambda_0, \nu_0, s_0^2\)</span> that define the prior are referred to as hyperparameters. We will set them before running the model, although they could also be modeled if we wanted.</p></li>
</ol></li>
<li><p><strong>The (Data) Likelihood:</strong> the same as before, <span class="math inline">\(\mathbf{Y} | \boldsymbol{\beta}, \sigma^2 \sim N_N(X\boldsymbol{\beta}, \sigma^2 I_N).\)</span></p></li>
<li><p><strong>Posterior:</strong></p>
<ol type="1">
<li><span class="math inline">\(\boldsymbol{\beta} | \sigma^2, y \sim N_2(\boldsymbol{\beta}_N, \sigma^2 \Lambda_N^{-1})\)</span> where <span class="math inline">\(\boldsymbol{\beta}_N = \Lambda_N^{-1}(\mathbf{X}'\mathbf{X} \hat{\boldsymbol{\beta}} + \Lambda_0 \boldsymbol{\beta}_0)\)</span> and <span class="math inline">\(\Lambda_N = (\mathbf{X}'\mathbf{X} + \Lambda_0).\)</span></li>
<li><span class="math inline">\(\sigma^2 | y \sim InvGamma(\sigma^2 | \frac{\nu_0 + N}{2}, \frac{1}{2} \nu_0 s_0^2 + \frac{1}{2}(\mathbf{y}'\mathbf{y} + \boldsymbol{\beta}_0'\Lambda_0 \boldsymbol{\beta}_0 - \boldsymbol{\beta}_N' \Lambda_N \boldsymbol{\beta}_N)).\)</span></li>
</ol></li>
</ol>
<p>We could again program this model using the analytic posterior. Instead, we’ll program it only through the priors and likelihood and let Stan approximate the posterior. I will also allow the model to include more than one predictor so that <span class="math inline">\(\mathbf{X}\)</span> is a <span class="math inline">\(N \times (K+1)\)</span> matrix augmented with a column of ones. (<a href="conjugate-regression.stan" target="_blank">Download the file here</a>)</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>conjugate-regression.stan</strong></pre>
</div>
<div class="sourceCode" id="cb40" data-filename="conjugate-regression.stan"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">// The input data is a vector 'y' of length 'N'.</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; N;</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; K;</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] y;</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N, K] X;</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// hyperparameters</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> beta_0;</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; lambda_0;</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; nu_0;</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; s_02;</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed data</span> {</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">matrix</span>[N, K+<span class="dv">1</span>] X_mat = append_col(rep_vector(<span class="dv">1</span>, N), X);</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vector</span>[K+<span class="dv">1</span>] beta_0_vec = rep_vector(beta_0, K+<span class="dv">1</span>);</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">matrix</span>[K+<span class="dv">1</span>, K+<span class="dv">1</span>] Lambda_0 = lambda_0 * identity_matrix(K+<span class="dv">1</span>);</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a><span class="co">// The parameters accepted by the model. Our model</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a><span class="co">// accepts two parameters 'mu' and 'sigma'.</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[K+<span class="dv">1</span>] beta;</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma2;</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a><span class="co">// The model to be estimated. We model the output</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a><span class="co">// 'y' to be normally distributed with mean 'mu'</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a><span class="co">// and standard deviation 'sigma'.</span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>  beta ~ multi_normal(beta_0_vec, sigma2 * Lambda_0);</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>  sigma2 ~ scaled_inv_chi_square(nu_0, s_02);</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>  y ~ normal(X_mat * beta, sqrt(sigma2));</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a><span class="kw">generated quantities</span> {</span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">real</span> sigma = sqrt(sigma2);</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vector</span>[N] y_ppd;</span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>        y_ppd[i] = normal_rng(X_mat[i,] * beta, sqrt(sigma2));</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>data_list2 <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> <span class="fu">nrow</span>(ncaaw),</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">K =</span> <span class="dv">1</span>,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> ncaaw<span class="sc">$</span>W,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">X =</span> <span class="fu">as.matrix</span>(ncaaw<span class="sc">$</span>FG3pct, <span class="at">nrow =</span> <span class="fu">nrow</span>(ncaaw)),</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># hyperparameters</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta_0 =</span> <span class="dv">0</span>,</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda_0 =</span> <span class="fl">0.5</span>,</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">nu_0 =</span> <span class="dv">1</span>,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">s_02 =</span> <span class="dv">47</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>file2 <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"conjugate-regression.stan"</span>)</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>conj_model <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(file2)</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> conj_model<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_list2,</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter_sampling =</span> <span class="dv">1000</span>,</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> <span class="dv">1</span>,</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">500</span>,</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_messages =</span> <span class="cn">TRUE</span>,</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_exceptions =</span> <span class="cn">FALSE</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 2 sequential chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 0.5 seconds.
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 0.5 seconds.

Both chains finished successfully.
Mean chain execution time: 0.5 seconds.
Total execution time: 1.2 seconds.</code></pre>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>fit2<span class="sc">$</span><span class="fu">diagnostic_summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$num_divergent
[1] 0 0

$num_max_treedepth
[1] 0 0

$ebfmi
[1] 0.9378670 0.9963986</code></pre>
</div>
</div>
<div id="fig-traceplots-conj" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-traceplots-conj-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(fit2<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"sigma"</span>)))</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_dens_overlay</span>(fit2<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"sigma"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-traceplots-conj" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-traceplots-conj-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-traceplots-conj-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-traceplots-conj-1.png" class="img-fluid figure-img" data-ref-parent="fig-traceplots-conj" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-traceplots-conj-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Traceplots for <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span>.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-traceplots-conj" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-traceplots-conj-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-traceplots-conj-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-traceplots-conj-2.png" class="img-fluid figure-img" data-ref-parent="fig-traceplots-conj" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-traceplots-conj-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Approximate posterior densities for <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span>.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-traceplots-conj-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Diagnostic plots for the posterior samples. Plots were made using the <code>bayesplot</code> package.
</figcaption>
</figure>
</div>
<p>Again the MCMC chains and diagnostics look satisfactory. The summary statistics for the parameters are displayed in <a href="#tbl-conj-inf" class="quarto-xref">Table&nbsp;3</a>.</p>
<div class="cell">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>fit2<span class="sc">$</span><span class="fu">summary</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"sigma"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>, <span class="at">format =</span> <span class="st">"html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="tbl-conj-inf" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-conj-inf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Summary statistics for the posterior samples for <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span>.
</figcaption>
<div aria-describedby="tbl-conj-inf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">median</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mad</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q95</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rhat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_bulk</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">beta[1]</td>
<td style="text-align: right;">-10.1791619</td>
<td style="text-align: right;">-10.239600</td>
<td style="text-align: right;">2.5123209</td>
<td style="text-align: right;">2.6138979</td>
<td style="text-align: right;">-14.3625850</td>
<td style="text-align: right;">-6.2677275</td>
<td style="text-align: right;">1.001439</td>
<td style="text-align: right;">521.5164</td>
<td style="text-align: right;">574.8934</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[2]</td>
<td style="text-align: right;">0.8572707</td>
<td style="text-align: right;">0.859365</td>
<td style="text-align: right;">0.0810363</td>
<td style="text-align: right;">0.0845927</td>
<td style="text-align: right;">0.7317652</td>
<td style="text-align: right;">0.9932626</td>
<td style="text-align: right;">1.001122</td>
<td style="text-align: right;">537.6317</td>
<td style="text-align: right;">556.3745</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">5.9874354</td>
<td style="text-align: right;">5.976395</td>
<td style="text-align: right;">0.2422073</td>
<td style="text-align: right;">0.2370974</td>
<td style="text-align: right;">5.6090195</td>
<td style="text-align: right;">6.4224640</td>
<td style="text-align: right;">1.003337</td>
<td style="text-align: right;">627.6261</td>
<td style="text-align: right;">577.8970</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
<p>And here’s a quick reminder of our results for the non-informative prior and MLE fits in <a href="#tbl-fit-comp" class="quarto-xref">Table&nbsp;4</a>.</p>
<div class="cell">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>mcmc_summary <span class="ot">&lt;-</span> <span class="fu">cbind</span>(mles,</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  fit1<span class="sc">$</span><span class="fu">summary</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"sigma"</span>))[,<span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"sd"</span>)])</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>mcmc_summary <span class="ot">&lt;-</span> <span class="fu">cbind</span>(mcmc_summary,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  fit2<span class="sc">$</span><span class="fu">summary</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"sigma"</span>))[,<span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"sd"</span>)])</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(mcmc_summary) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Variable"</span>, <span class="st">"MLE"</span>, <span class="st">"Non-info Est"</span>, <span class="st">"Non-info SD"</span>, <span class="st">"Conj Est"</span>, <span class="st">"Conj SD"</span>)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>mcmc_summary <span class="sc">|&gt;</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>, <span class="at">format =</span> <span class="st">"html"</span>, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="tbl-fit-comp" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-fit-comp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4: Comparison of the estimates for <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span>.
</figcaption>
<div aria-describedby="tbl-fit-comp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">MLE</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Non-info Est</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Non-info SD</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Conj Est</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Conj SD</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: left;">beta_0</td>
<td style="text-align: right;">-14.945</td>
<td style="text-align: right;">-15.170</td>
<td style="text-align: right;">2.726</td>
<td style="text-align: right;">-10.179</td>
<td style="text-align: right;">2.512</td>
</tr>
<tr class="even">
<td style="text-align: left;">FG3pct</td>
<td style="text-align: left;">beta_1</td>
<td style="text-align: right;">1.009</td>
<td style="text-align: right;">1.017</td>
<td style="text-align: right;">0.088</td>
<td style="text-align: right;">0.857</td>
<td style="text-align: right;">0.081</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">5.908</td>
<td style="text-align: right;">5.928</td>
<td style="text-align: right;">0.219</td>
<td style="text-align: right;">5.987</td>
<td style="text-align: right;">0.242</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
<p>In <a href="#fig-conj-ci-1" class="quarto-xref">Figure&nbsp;7 (a)</a> we have the 50% and 95% CIs with the posterior mean displayed as a point. The densities are plotted in ridgelines in <a href="#fig-conj-ci-2" class="quarto-xref">Figure&nbsp;7 (b)</a>.</p>
<div id="fig-conj-ci" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-conj-ci-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_intervals</span>(fit2<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"sigma"</span>)))</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas_ridges</span>(fit2<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"sigma"</span>)),</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prob_outer =</span> <span class="fl">0.95</span>, <span class="at">prob =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-conj-ci" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-conj-ci-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-conj-ci-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-conj-ci-1.png" class="img-fluid figure-img" data-ref-parent="fig-conj-ci" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-conj-ci-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Interval plots for <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span>.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-conj-ci" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-conj-ci-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-conj-ci-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-conj-ci-2.png" class="img-fluid figure-img" data-ref-parent="fig-conj-ci" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-conj-ci-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Approximate posterior densities for <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span> in a ridgeline plot.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-conj-ci-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Plots for the 50% Credible Interval (inner band) and 95% Credible Interval (outer band) for <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span>. Plots were made using the <code>bayesplot</code> package.
</figcaption>
</figure>
</div>
<p>We collect the PPD draws from the fit object using the draws method. From <a href="#fig-conj-ppc" class="quarto-xref">Figure&nbsp;8</a> we can see that while the predictive densities match pretty well and the intervals are centered on the OLS line of best fit.</p>
<div id="fig-conj-ppc" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-conj-ppc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>y_ppd <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">as_draws_df</span>(fit2<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="st">"y_ppd"</span>)))</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ppc_dens_overlay</span>(ncaaw<span class="sc">$</span>W,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>                 y_ppd[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">350</span>]) <span class="sc">+</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Density of PPD Draws of NCAAW Wins"</span>,</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Wins"</span>)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ppc_intervals</span>(ncaaw<span class="sc">$</span>W,</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>                 y_ppd[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">350</span>],</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">x =</span> ncaaw<span class="sc">$</span>FG3pct) <span class="sc">+</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Density of PPD Draws of NCAAW Wins by 3pt%"</span>,</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"3pt%"</span>,</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Wins"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-conj-ppc" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-conj-ppc-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-conj-ppc-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-conj-ppc-1.png" class="img-fluid figure-img" data-ref-parent="fig-conj-ppc" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-conj-ppc-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) PPD densities for the wins given 3pt%.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-conj-ppc" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-conj-ppc-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-conj-ppc-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-conj-ppc-2.png" class="img-fluid figure-img" data-ref-parent="fig-conj-ppc" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-conj-ppc-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) PPD intervals for the wins plotted by 3pt%.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-conj-ppc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Posterior Predictive Check plots from <code>bayesplot</code>.
</figcaption>
</figure>
</div>
</section>
</section>
<section id="some-other-useful-resources-for-stan" class="level2">
<h2 class="anchored" data-anchor-id="some-other-useful-resources-for-stan">Some Other Useful Resources for Stan</h2>
<p>First, here’s the three essential guides for using Stan:</p>
<ul>
<li><p><a href="https://mc-stan.org/docs/functions-reference/index.html">Stan Function Guide</a> - reference for all the built-in functions and distributions as well as guides for writing custom functions and distributions</p></li>
<li><p><a href="https://mc-stan.org/docs/stan-users-guide/index.html">Stan User’s Guide</a> - reference for example models, how to build efficient models, and some inference techniques</p></li>
<li><p><a href="https://mc-stan.org/docs/reference-manual/index.html">Stan Reference Manual</a> - reference for programming in Stan with a focus on how the language works</p></li>
</ul>
<p>Here are some other useful packages to use for Bayesian data analysis with Stan (or other packages). We used some of these in this tutorial!</p>
<ul>
<li><p><a href="https://paul-buerkner.github.io/brms/index.html">brms</a>: Bayesian regression models using Stan</p></li>
<li><p><a href="https://mc-stan.org/posterior/">posterior</a>: Useful for working with Stan output</p></li>
<li><p><a href="http://mc-stan.org/bayesplot">bayesplot</a>: ggplot2-based plotting functions for MCMC draws designed work well with Stan</p></li>
<li><p><a href="http://mc-stan.org/loo">loo</a>: Leave-one-out cross validation for model checking and selection that works with the log-posterior. Works best with <code>rstanarm</code> but can work with <code>cmdstanr</code> too.</p></li>
</ul>
<p>Here’s a list of useful resources for debugging issues with divergences, hitting maximum tree-depth, low EBFMI, and understanding diagnostics:</p>
<ul>
<li><p><a href="https://mc-stan.org/misc/warnings.html">Stan’s Guide to Runtime warnings and convergence problems</a></p></li>
<li><p><a href="https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations">Prior Choices and Selection</a></p></li>
<li><p><a href="https://arxiv.org/pdf/1909.11827.pdf">Convergence Diagnostics for MCMC</a></p></li>
<li><p><a href="https://discourse.mc-stan.org/">Official Stan Forum</a></p></li>
</ul>
</section>
<section id="bonus-regression-modeling-with-incomplete-data" class="level2">
<h2 class="anchored" data-anchor-id="bonus-regression-modeling-with-incomplete-data">Bonus: Regression Modeling with Incomplete Data</h2>
<p>As a bonus section, we’ll use the <code>brms</code> package to fit a regression model where we have incomplete predictor observations. Incomplete data analysis ranges from complete case analysis (incomplete cases are dropped) and mean imputation to multiple imputation, joint modeling, and EM algorithm <span class="citation" data-cites="schafer2002">(<a href="#ref-schafer2002" role="doc-biblioref">Schafer and Graham 2002</a>)</span>.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> We’re going to use <code>mice</code> <span class="citation" data-cites="buuren2010mice">(<a href="#ref-buuren2010mice" role="doc-biblioref">Buuren and Groothuis-Oudshoorn 2010</a>)</span> and <code>brms</code> <span class="citation" data-cites="bürkner2018">(<a href="#ref-bürkner2018" role="doc-biblioref">Bürkner 2018</a>)</span> to demonstrate the imputation and fitting Bayesian regression models with a convenient front-end that writes the Stan code for us.</p>
<p>In our case, we are going to use junior year scoring (points per game) to predict senior year scoring for women’s college basketball players from 2020-21 to the 2022-23 seasons. The data set only contains players who played in at least 75% of games each season, so partial seasons due to injury or being a bench player are excluded. Players who only have a junior season are excluded from the analysis.</p>
<div class="cell">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>ncaaw_i <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/ncaaw-individuals.csv"</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ncaaw_i)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>             Name Pos_jr Pos_sr G_jr G_sr PPG_jr PPG_sr Cl_jr
1     A'Jah Davis      F      F   29   32   16.6   16.2   Jr.
2 Abby Brockmeyer      F      F   NA   31     NA   16.3   Jr.
3       Abby Feit      F      F   29   28   15.1   15.5   Jr.
4     Abby Meyers      G      G   NA   30     NA   17.9   Jr.
5     Abby Meyers      G      G   NA   35     NA   14.3   Jr.
6   Adriana Shipp      G      G   NA   30     NA   13.9   Jr.</code></pre>
</div>
</div>
<p>Our imputation model will be univariate linear regression that use all other variables as predictors. For example, imputing <span class="math inline">\(PPG_{jr}\)</span> will be done by regressing on <span class="math inline">\(PPG_{sr}, G_{jr}, G_{sr}\)</span>. <span class="math inline">\(PPG_{jr}\)</span> and <span class="math inline">\(G_{jr}\)</span> are incomplete for <span class="math inline">\(n_{mis} = 176\)</span> players while <span class="math inline">\(n_{obs} = 98\)</span> players have stats from both years. This missing data pattern is displayed in <a href="#fig-miss-patt" class="quarto-xref">Figure&nbsp;9</a>.</p>
<div class="cell">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mice)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'mice'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:stats':

    filter</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    cbind, rbind</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>m_pat <span class="ot">&lt;-</span> <span class="fu">md.pattern</span>(ncaaw_i, <span class="at">plot =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-miss-patt" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-miss-patt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-miss-patt-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-miss-patt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Missing data patterns for the NCAA women’s basketball players from 2020-2023 who played in their junior and senior year. The red boxes correspond to missing values, so there are 176 players who recorded full senior seasons (played in &gt;75% of total games) but missing or shortened junior seasons.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ncaaw_i, <span class="fu">aes</span>(PPG_jr, PPG_sr, <span class="at">color =</span> G_jr)) <span class="sc">+</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_viridis_c</span>(<span class="at">name =</span> <span class="st">"G - Jr"</span>) <span class="sc">+</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"PPG - Jr"</span>,</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"PPG - Sr"</span>) <span class="sc">+</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell-output-display">
<div id="fig-ppg-jr-sr" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ppg-jr-sr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-ppg-jr-sr-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ppg-jr-sr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: Points per game (PPG) from Junior and Senior seasons.
</figcaption>
</figure>
</div>
</div>
</div>
<section id="multiple-imputation-with-mice" class="level3">
<h3 class="anchored" data-anchor-id="multiple-imputation-with-mice">Multiple Imputation with mice</h3>
<p>First, we’ll try out imputing before model fitting using <code>mice</code>. MICE stands for Multiple Imputation by Chained Equations and is procedure that creates a set of <span class="math inline">\(M\)</span> completed data sets from an incomplete data set. Multiple Imputation is a three stage procedure:</p>
<ol type="1">
<li>Each incomplete variable is imputed with posterior predictive draws from a regression model with all other variables as predictors. The procedure iterates through the incomplete variables several times to converge to the posterior predictive distribution of the missing data given the observed.</li>
<li>These completed data sets are then analyzed individually with a standard complete data method.</li>
<li>Results from each analysis are combined. Typically this is done with Rubin’s rules <span class="citation" data-cites="rubin1987">(<a href="#ref-rubin1987" role="doc-biblioref">Rubin 1987</a>)</span>, but <code>brms</code> follows the advice of <span class="citation" data-cites="zhou2010">Zhou and Reiter (<a href="#ref-zhou2010" role="doc-biblioref">2010</a>)</span> and simply stacks the posterior draw matrices from each fitted model.</li>
</ol>
<div class="cell" data-hash="intro_to_stan_cache/html/mice-fit_1d9fae28e49d28fe5700af6bdd429587">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>imps <span class="ot">&lt;-</span> <span class="fu">mice</span>(ncaaw_i, <span class="at">m =</span> <span class="dv">10</span>, <span class="at">method =</span> <span class="st">"norm"</span>, <span class="at">maxit =</span> <span class="dv">10</span>, <span class="at">printFlag =</span> <span class="cn">FALSE</span>)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>fit_brm_mice <span class="ot">&lt;-</span> <span class="fu">brm_multiple</span>(PPG_sr <span class="sc">~</span> G_jr <span class="sc">*</span> PPG_jr, <span class="at">data =</span> imps, <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>                             <span class="at">refresh =</span> <span class="dv">0</span>)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_brm_mice)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: PPG_sr ~ G_jr * PPG_jr 
   Data: imps (Number of observations: 274) 
  Draws: 20 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 20000

Population-Level Effects: 
            Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept      18.23      6.45     5.81    31.16 1.49       37      106
G_jr           -0.26      0.25    -0.77     0.23 1.51       36       94
PPG_jr         -0.12      0.39    -0.89     0.62 1.55       35      110
G_jr:PPG_jr     0.02      0.02    -0.01     0.05 1.57       34       94

Family Specific Parameters: 
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     2.21      0.10     2.01     2.42 1.11      118      372

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
</section>
<section id="imputation-during-model-fitting" class="level3">
<h3 class="anchored" data-anchor-id="imputation-during-model-fitting">Imputation During Model Fitting</h3>
<p>Imputation during model fitting takes a different approach. Imputations are made for each incomplete variable using a different conditional model for each variable. This approach differs from MI and MICE in two key ways: (i) the model is only fit once since the imputation model is part of the analysis model, (ii) the model must be constructed uniquely for each analysis scenario whereas MI completed data sets can be re-used with different analyses.</p>
<div class="cell" data-hash="intro_to_stan_cache/html/brm-mi-fit_5b7ec6b19025404ce963ffc9e5d4e3fb">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>bform <span class="ot">&lt;-</span> <span class="fu">bf</span>(PPG_sr <span class="sc">|</span> <span class="fu">mi</span>() <span class="sc">~</span> <span class="fu">mi</span>(G_jr) <span class="sc">*</span> <span class="fu">mi</span>(PPG_jr)) <span class="sc">+</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bf</span>(PPG_jr <span class="sc">|</span> <span class="fu">mi</span>() <span class="sc">~</span> G_sr <span class="sc">+</span> PPG_sr) <span class="sc">+</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bf</span>(G_jr <span class="sc">|</span> <span class="fu">mi</span>() <span class="sc">~</span> G_sr <span class="sc">+</span> PPG_sr) <span class="sc">+</span> <span class="fu">set_rescor</span>(<span class="cn">FALSE</span>)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>fit_brm_mi <span class="ot">&lt;-</span> <span class="fu">brm</span>(bform, <span class="at">data =</span> ncaaw_i, </span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">refresh =</span> <span class="dv">500</span>, <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">thin =</span> <span class="dv">1</span>,</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">backend =</span> <span class="st">"cmdstanr"</span>, </span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.8</span>, </span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">max_depth =</span> <span class="dv">10</span>,</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>                                <span class="at">show_exceptions =</span> <span class="cn">FALSE</span>),</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">cores =</span> <span class="dv">2</span>)</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_brm_mi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: MV(gaussian, gaussian, gaussian) 
  Links: mu = identity; sigma = identity
         mu = identity; sigma = identity
         mu = identity; sigma = identity 
Formula: PPG_sr | mi() ~ mi(G_jr) * mi(PPG_jr) 
         PPG_jr | mi() ~ G_sr + PPG_sr 
         G_jr | mi() ~ G_sr + PPG_sr 
   Data: ncaaw_i (Number of observations: 274) 
  Draws: 2 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 2000

Population-Level Effects: 
                      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
PPGsr_Intercept          16.10      2.29    11.60    20.74 1.00      615
PPGjr_Intercept           5.95      2.33     1.14    10.46 1.00      900
Gjr_Intercept             2.98      6.31    -9.27    15.38 1.00      789
PPGjr_G_sr               -0.04      0.06    -0.17     0.09 1.00     1053
PPGjr_PPG_sr              0.72      0.08     0.56     0.89 1.00      732
Gjr_G_sr                  0.56      0.18     0.19     0.90 1.00      807
Gjr_PPG_sr                0.28      0.23    -0.16     0.72 1.00      622
PPGsr_miG_jr             -0.30      0.09    -0.48    -0.12 1.00      565
PPGsr_miPPG_jr           -0.04      0.15    -0.32     0.26 1.00      591
PPGsr_miG_jr:miPPG_jr     0.02      0.01     0.01     0.03 1.00      544
                      Tail_ESS
PPGsr_Intercept            631
PPGjr_Intercept           1221
Gjr_Intercept             1290
PPGjr_G_sr                1244
PPGjr_PPG_sr              1345
Gjr_G_sr                  1182
Gjr_PPG_sr                 874
PPGsr_miG_jr               589
PPGsr_miPPG_jr             736
PPGsr_miG_jr:miPPG_jr      605

Family Specific Parameters: 
            Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma_PPGsr     1.86      0.09     1.70     2.04 1.00     1706     1355
sigma_PPGjr     2.31      0.15     2.04     2.63 1.00      634     1066
sigma_Gjr       5.33      0.38     4.66     6.15 1.00      650     1214

Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p><code>brms</code> is built on Stan, so we can also take a look at the traceplots of the samples in <a href="#fig-brm-mi-trace" class="quarto-xref">Figure&nbsp;11</a>.</p>
<div class="cell" data-layout-nrow="2">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit_brm_mi, <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">"b_PPGsr"</span>, <span class="st">"bsp_"</span>), <span class="at">regex =</span> <span class="cn">TRUE</span>, <span class="at">ask =</span> <span class="cn">FALSE</span>, <span class="at">N =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="fig-brm-mi-trace" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-brm-mi-trace-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-brm-mi-trace" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-brm-mi-trace-1" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-brm-mi-trace-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-brm-mi-trace-1.png" id="fig-brm-mi-trace-1" class="img-fluid figure-img" data-ref-parent="fig-brm-mi-trace" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-brm-mi-trace-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-brm-mi-trace" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-brm-mi-trace-2" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-brm-mi-trace-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-brm-mi-trace-2.png" id="fig-brm-mi-trace-2" class="img-fluid figure-img" data-ref-parent="fig-brm-mi-trace" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-brm-mi-trace-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-brm-mi-trace-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: Traceplots of brms analysis model parameters.
</figcaption>
</figure>
</div>
</div>
<div class="cell" data-layout-nrow="2">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit_brm_mi, <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">"b_PPGjr"</span>, <span class="st">"b_Gjr"</span>), <span class="at">regex =</span> <span class="cn">TRUE</span>, <span class="at">ask =</span> <span class="cn">FALSE</span>, <span class="at">N =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="fig-brm-mi-trace-imp" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-brm-mi-trace-imp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-brm-mi-trace-imp" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-brm-mi-trace-imp-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-brm-mi-trace-imp-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-brm-mi-trace-imp-1.png" class="img-fluid figure-img" data-ref-parent="fig-brm-mi-trace-imp" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-brm-mi-trace-imp-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) <span class="math inline">\(PPG_{jr}\)</span> imputation model parameters
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-brm-mi-trace-imp" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-brm-mi-trace-imp-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-brm-mi-trace-imp-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-brm-mi-trace-imp-2.png" class="img-fluid figure-img" data-ref-parent="fig-brm-mi-trace-imp" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-brm-mi-trace-imp-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) <span class="math inline">\(G_{jr}\)</span> imputation model parameters
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-brm-mi-trace-imp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: Traceplots of brms imputation model parameters.
</figcaption>
</figure>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-with-filename-file">
<pre><strong>intro-to-stan.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(brms<span class="sc">::</span><span class="fu">conditional_effects</span>(fit_brm_mice, <span class="st">"PPG_jr:G_jr"</span>, <span class="at">resp =</span> <span class="st">"PPGsr"</span>))</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(brms<span class="sc">::</span><span class="fu">conditional_effects</span>(fit_brm_mi, <span class="st">"PPG_jr:G_jr"</span>, <span class="at">resp =</span> <span class="st">"PPGsr"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="fig-brm-mi-cond-eff" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-brm-mi-cond-eff-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div id="fig-brm-mi-cond-eff-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-brm-mi-cond-eff-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-brm-mi-cond-eff-1.png" class="img-fluid figure-img" data-ref-parent="fig-brm-mi-cond-eff" width="576">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-brm-mi-cond-eff-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Estimates after MICE imputation
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-brm-mi-cond-eff-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-brm-mi-cond-eff-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="intro_to_stan_files/figure-html/fig-brm-mi-cond-eff-2.png" class="img-fluid figure-img" data-ref-parent="fig-brm-mi-cond-eff" width="576">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-brm-mi-cond-eff-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Estimates with joint model
</figcaption>
</figure>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-brm-mi-cond-eff-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13: The estimated conditional effects of PPG as a junior and junior-year Games played on PPG as a senior.
</figcaption>
</figure>
</div>
</div>


<!-- -->


</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-bürkner2018" class="csl-entry" role="listitem">
Bürkner, Paul-Christian. 2018. <span>“Advanced Bayesian Multilevel Modeling with the R Package Brms.”</span> <em>The R Journal</em> 10 (1): 395. <a href="https://doi.org/10.32614/RJ-2018-017">https://doi.org/10.32614/RJ-2018-017</a>.
</div>
<div id="ref-buuren2010mice" class="csl-entry" role="listitem">
Buuren, S van, and Karin Groothuis-Oudshoorn. 2010. <span>“Mice: Multivariate Imputation by Chained Equations in r.”</span> <em>Journal of Statistical Software</em>, 168.
</div>
<div id="ref-cmdstanp" class="csl-entry" role="listitem">
<span>“Cmdstanpy <span></span> Python Interface to CmdStan <span></span> CmdStanPy 1.1.0 Documentation.”</span> n.d. <a href="https://mc-stan.org/cmdstanpy/index.html">https://mc-stan.org/cmdstanpy/index.html</a>.
</div>
<div id="ref-dempster1977" class="csl-entry" role="listitem">
Dempster, A. P., Martin Schatzoff, and Nanny Wermuth. 1977. <span>“A Simulation Study of Alternatives to Ordinary Least Squares.”</span> <em>Journal of the American Statistical Association</em> 72 (357): 77–91. <a href="https://doi.org/10.2307/2286909">https://doi.org/10.2307/2286909</a>.
</div>
<div id="ref-gabry2023" class="csl-entry" role="listitem">
Gabry, Jonah, Rok Češnovar, and Andrew Johnson. 2023. <em>Cmdstanr: R Inferfacet to ’CmdStan’</em>. <a href="https://mc-stan.org/cmdstanr/, https://discourse.mc-stan.org">https://mc-stan.org/cmdstanr/, https://discourse.mc-stan.org</a>.
</div>
<div id="ref-gelman2013bayesian" class="csl-entry" role="listitem">
Gelman, Andrew, Hal S Stern, John B Carlin, David B Dunson, Aki Vehtari, and Donald B Rubin. 2013. <em>Bayesian Data Analysis</em>. Chapman; Hall/CRC.
</div>
<div id="ref-harel2007multiple" class="csl-entry" role="listitem">
Harel, Ofer, and Xiao-Hua Zhou. 2007. <span>“Multiple Imputation: Review of Theory, Implementation and Software.”</span> <em>Statistics in Medicine</em> 26 (16): 30573077.
</div>
<div id="ref-rubin1976" class="csl-entry" role="listitem">
Rubin, Donald B. 1976. <span>“Inference and Missing Data.”</span> <em>Biometrika</em> 63 (3): 581–92. <a href="https://www.jstor.org/stable/2335739">https://www.jstor.org/stable/2335739</a>.
</div>
<div id="ref-rubin1987" class="csl-entry" role="listitem">
———. 1987. <em>Multiple Imputation for Nonresponse in Surveys | Wiley Series in Probability and Statistics</em>. Wiley series in probability and mathematical statistics : Applied probability and statistics. New York: Wiley. <a href="https://onlinelibrary.wiley.com/doi/book/10.1002/9780470316696">https://onlinelibrary.wiley.com/doi/book/10.1002/9780470316696</a>.
</div>
<div id="ref-schafer2002" class="csl-entry" role="listitem">
Schafer, Joseph L., and John W. Graham. 2002. <span>“Missing Data: Our View of the State of the Art.”</span> <em>Psychological Methods</em> 7 (2): 147–77. <a href="https://doi.org/10.1037/1082-989X.7.2.147">https://doi.org/10.1037/1082-989X.7.2.147</a>.
</div>
<div id="ref-white2011" class="csl-entry" role="listitem">
White, Ian R., Patrick Royston, and Angela M. Wood. 2011. <span>“Multiple Imputation Using Chained Equations: Issues and Guidance for Practice.”</span> <em>Statistics in Medicine</em> 30 (4): 377–99. <a href="https://doi.org/10.1002/sim.4067">https://doi.org/10.1002/sim.4067</a>.
</div>
<div id="ref-zhou2010" class="csl-entry" role="listitem">
Zhou, Xiang, and Jerome P. Reiter. 2010. <span>“A Note on Bayesian Inference After Multiple Imputation.”</span> <em>The American Statistician</em> 64 (2): 159–63. <a href="https://doi.org/10.1198/tast.2010.09109">https://doi.org/10.1198/tast.2010.09109</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>See wikipedia for more details and derivations: <a href="https://en.wikipedia.org/wiki/Bayesian_linear_regression" class="uri">https://en.wikipedia.org/wiki/Bayesian_linear_regression</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>See <span class="citation" data-cites="rubin1976">White, Royston, and Wood (<a href="#ref-white2011" role="doc-biblioref">2011</a>)</span> for more details on incomplete data analysis.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/benjamin-stockton\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb65" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Getting to know Stan - SWOSC"</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Ben Stockton"</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 11-16-2023</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="co">    html:</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="co">        code-fold: show</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="co">        code-tools: true</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a><span class="co">        toc: true</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="co">        toc-location: left</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="co">        link-external-newwindow: true</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a><span class="co">        citations-hover: true</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> swosc-stan.bib</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> [bayesian-analysis, computation, tutorial]</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a><span class="al">![](stan_logo.png)</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a><span class="fu">## Installation</span></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>To get started, we'll head over to Stan's <span class="co">[</span><span class="ot">documentation</span><span class="co">](https://mc-stan.org/)</span> to see how to get set up in R. For this presentation, I'll use the CmdStan toolchain that's implemented in R by the <span class="in">`cmdstanr`</span> <span class="co">[</span><span class="ot">package</span><span class="co">](https://mc-stan.org/cmdstanr/)</span> <span class="co">[</span><span class="ot">@gabry2023</span><span class="co">]</span>. There are also Python, command line, Matlab, Julia, and Stata interfaces to Stan and a Python interface for cmdstan called <span class="co">[</span><span class="ot">CmdStanPy</span><span class="co">](https://github.com/stan-dev/cmdstanpy)</span> <span class="co">[</span><span class="ot">@cmdstanp</span><span class="co">]</span>.</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: set-up</span></span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(98463)</span></span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a><span class="in"># install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))</span></span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a><span class="in">library(cmdstanr)</span></span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a><span class="in"># cmdstanr::install_cmdstan()</span></span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a><span class="in">cmdstanr::cmdstan_version()</span></span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a><span class="in">cmdstanr::cmdstan_path()</span></span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a><span class="in">cmdstanr::check_cmdstan_toolchain()</span></span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a><span class="in"># install.packages(c("bayesplot", "ggplot2", "posterior"))</span></span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-40"><a href="#cb65-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-41"><a href="#cb65-41" aria-hidden="true" tabindex="-1"></a><span class="fu">## A Very Brief Introduction to Bayesian Data Analysis</span></span>
<span id="cb65-42"><a href="#cb65-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-43"><a href="#cb65-43" aria-hidden="true" tabindex="-1"></a>The broadest conceptual overview of Bayesian data analysis is that this methodology allows us to incorporate prior knowledge about the model/data into our analysis which is based on a posterior distribution that is derived from the prior and likelihood. Bayesian inference treats the parameters of the model as random variables whose distribution we are interested in either deriving analytically or approximating through computation. This is a key distinction from frequentist methods taught in math stat and applied stat where parameters are fixed values and their estimators are functions of a random sample and the sampling distribution of the estimator is used for inference.</span>
<span id="cb65-44"><a href="#cb65-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-45"><a href="#cb65-45" aria-hidden="true" tabindex="-1"></a>::: callout-important</span>
<span id="cb65-46"><a href="#cb65-46" aria-hidden="true" tabindex="-1"></a><span class="fu">## Bayes Rule</span></span>
<span id="cb65-47"><a href="#cb65-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-48"><a href="#cb65-48" aria-hidden="true" tabindex="-1"></a>A quick reminder of Bayes Rule.</span>
<span id="cb65-49"><a href="#cb65-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-50"><a href="#cb65-50" aria-hidden="true" tabindex="-1"></a>Let $\theta$ be a random variable with (prior) distribution $p(\theta)$, $Y$ be a random variable that depends on $\theta$ with conditional distribution or likelihood $p(y | \theta)$. Then their joint distribution is $p(y, \theta) = p(y|\theta) p(\theta)$.</span>
<span id="cb65-51"><a href="#cb65-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-52"><a href="#cb65-52" aria-hidden="true" tabindex="-1"></a>Bayes rule lets us flip the conditioning from the likelihood to get $p(\theta | y)$</span>
<span id="cb65-53"><a href="#cb65-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-54"><a href="#cb65-54" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb65-55"><a href="#cb65-55" aria-hidden="true" tabindex="-1"></a>p(\theta | y) = \frac{p(y, \theta)}{p(y)} = \frac{p(y|\theta) p(\theta)}{\int p(y, \theta) d\theta} \propto p(y|\theta) p(\theta)</span>
<span id="cb65-56"><a href="#cb65-56" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb65-57"><a href="#cb65-57" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb65-58"><a href="#cb65-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-59"><a href="#cb65-59" aria-hidden="true" tabindex="-1"></a>To be a little more specific, we have three central components to the model. For ease of exposition, let's consider the simple regression model $E(Y_i | X_i = x_i, \boldsymbol{\beta}, \sigma^2) = \beta_0 + \beta_1 X_i$ and $Var(Y_i | X_i = x_i, \boldsymbol{\beta}, \sigma^2) = \sigma^2$ where we have $i = 1,\dots,N$ observations of $(Y_i, X_i)'$ from Ch. 14 of Bayesian Data Analysis <span class="co">[</span><span class="ot">@gelman2013bayesian, p. 354-358</span><span class="co">]</span>. From here on I will suppress conditioning on the observed predictor $X_i = x_i$ since we are considering the design matrix $X = (1_N, \mathbf{x})$ to be fixed and known where $\mathbf{x} = (x_1,\dots, x_N)'$.</span>
<span id="cb65-60"><a href="#cb65-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-61"><a href="#cb65-61" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**The Prior:** a distribution for the parameters that doesn't depend on the data $p(\theta)$.</span>
<span id="cb65-62"><a href="#cb65-62" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**The (Data) Likelihood:** a model for the data that depends on the parameters $p(y | \theta)$.</span>
<span id="cb65-63"><a href="#cb65-63" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**The Posterior:** a distribution that uses Bayes rule to define distribution of the parameters given the data $p(\theta|y)$.</span>
<span id="cb65-64"><a href="#cb65-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-65"><a href="#cb65-65" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why Stan?</span></span>
<span id="cb65-66"><a href="#cb65-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-67"><a href="#cb65-67" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Stan is one of several ways to run MCMC for Bayesian inference</span>
<span id="cb65-68"><a href="#cb65-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-69"><a href="#cb65-69" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Nimble and OpenBUGS are two other languages dedicated to probabilistic programming</span>
<span id="cb65-70"><a href="#cb65-70" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>R, Rcpp, Julia, and Python are other more general purpose options for writing the sampler from scratch</span>
<span id="cb65-71"><a href="#cb65-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-72"><a href="#cb65-72" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Other methods use combinations of Gibbs, Metropolis-Hastings, and slice sampling; Stan uses Hamiltonian Monte Carlo and the No-U-Turn Sampler (NUTS) which is more efficient and typically requires less thinning</span>
<span id="cb65-73"><a href="#cb65-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-74"><a href="#cb65-74" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Stan only allows for continuous parameters</span>
<span id="cb65-75"><a href="#cb65-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-76"><a href="#cb65-76" aria-hidden="true" tabindex="-1"></a><span class="fu">## Some examples in Stan</span></span>
<span id="cb65-77"><a href="#cb65-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-78"><a href="#cb65-78" aria-hidden="true" tabindex="-1"></a>We'll continue with the single predictor regression model to model NCAA Women's Basketball team's total wins by their 3 point field goal percentage from the 2022-2023 season. Data collected from <span class="co">[</span><span class="ot">NCAA</span><span class="co">](https://stats.ncaa.org/rankings?sport_code=WBB&amp;division=2)</span>.</span>
<span id="cb65-79"><a href="#cb65-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-80"><a href="#cb65-80" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-81"><a href="#cb65-81" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: load-data</span></span>
<span id="cb65-82"><a href="#cb65-82" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-83"><a href="#cb65-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-84"><a href="#cb65-84" aria-hidden="true" tabindex="-1"></a><span class="in">ncaaw &lt;- readr::read_csv(file = "Data/NCAAW-freethrows-threes-2022-2023.csv")</span></span>
<span id="cb65-85"><a href="#cb65-85" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-86"><a href="#cb65-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-87"><a href="#cb65-87" aria-hidden="true" tabindex="-1"></a>In the 2022-2023 season there were $N = 350$ teams. The relationship between their wins and three point percentage is displayed in @fig-scatter.</span>
<span id="cb65-88"><a href="#cb65-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-89"><a href="#cb65-89" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-90"><a href="#cb65-90" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-scatter</span></span>
<span id="cb65-91"><a href="#cb65-91" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-92"><a href="#cb65-92" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Scatter plot of the Total Wins by 3 pt Field Goal %. </span></span>
<span id="cb65-93"><a href="#cb65-93" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb65-94"><a href="#cb65-94" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(ncaaw, aes(FG3pct, W)) +</span></span>
<span id="cb65-95"><a href="#cb65-95" aria-hidden="true" tabindex="-1"></a><span class="in">    geom_point() +</span></span>
<span id="cb65-96"><a href="#cb65-96" aria-hidden="true" tabindex="-1"></a><span class="in">    labs(title = "2022-23 NCAAW Wins by 3pt%", </span></span>
<span id="cb65-97"><a href="#cb65-97" aria-hidden="true" tabindex="-1"></a><span class="in">         subtitle = paste0("r = ", round(cor(ncaaw$W, ncaaw$FG3pct), 3)),</span></span>
<span id="cb65-98"><a href="#cb65-98" aria-hidden="true" tabindex="-1"></a><span class="in">         x = "3pt%",</span></span>
<span id="cb65-99"><a href="#cb65-99" aria-hidden="true" tabindex="-1"></a><span class="in">         y = "Wins")</span></span>
<span id="cb65-100"><a href="#cb65-100" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-101"><a href="#cb65-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-102"><a href="#cb65-102" aria-hidden="true" tabindex="-1"></a>As a baseline, we'll find the maximum likelihood estimates for the regression parameters and variance.</span>
<span id="cb65-103"><a href="#cb65-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-104"><a href="#cb65-104" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-105"><a href="#cb65-105" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: lm-fit</span></span>
<span id="cb65-106"><a href="#cb65-106" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-107"><a href="#cb65-107" aria-hidden="true" tabindex="-1"></a><span class="in">fit_ml &lt;- lm(W ~ FG3pct, data = ncaaw)</span></span>
<span id="cb65-108"><a href="#cb65-108" aria-hidden="true" tabindex="-1"></a><span class="in">(beta_ml &lt;- coef(fit_ml))</span></span>
<span id="cb65-109"><a href="#cb65-109" aria-hidden="true" tabindex="-1"></a><span class="in">smry_ml &lt;- summary(fit_ml)</span></span>
<span id="cb65-110"><a href="#cb65-110" aria-hidden="true" tabindex="-1"></a><span class="in">(sigma_ml &lt;- smry_ml$sigma)</span></span>
<span id="cb65-111"><a href="#cb65-111" aria-hidden="true" tabindex="-1"></a><span class="in">mles &lt;- data.frame(Parameters = c("beta_0", "beta_1", "sigma"),</span></span>
<span id="cb65-112"><a href="#cb65-112" aria-hidden="true" tabindex="-1"></a><span class="in">                   Estimates = c(beta_ml, sigma_ml))</span></span>
<span id="cb65-113"><a href="#cb65-113" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-114"><a href="#cb65-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-115"><a href="#cb65-115" aria-hidden="true" tabindex="-1"></a>The fitted line is displayed in @fig-scatter-ols.</span>
<span id="cb65-116"><a href="#cb65-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-117"><a href="#cb65-117" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-118"><a href="#cb65-118" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-scatter-ols</span></span>
<span id="cb65-119"><a href="#cb65-119" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-120"><a href="#cb65-120" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Now the OLS regression line is super-imposed in blue.</span></span>
<span id="cb65-121"><a href="#cb65-121" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb65-122"><a href="#cb65-122" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(ncaaw, aes(FG3pct, W)) +</span></span>
<span id="cb65-123"><a href="#cb65-123" aria-hidden="true" tabindex="-1"></a><span class="in">    geom_point() +</span></span>
<span id="cb65-124"><a href="#cb65-124" aria-hidden="true" tabindex="-1"></a><span class="in">    geom_smooth(method = "lm", se = FALSE) +</span></span>
<span id="cb65-125"><a href="#cb65-125" aria-hidden="true" tabindex="-1"></a><span class="in">    labs(title = "2022-23 NCAAW Wins by 3pt%", </span></span>
<span id="cb65-126"><a href="#cb65-126" aria-hidden="true" tabindex="-1"></a><span class="in">         subtitle = paste0("r = ", round(cor(ncaaw$W, ncaaw$FG3pct), 3)),</span></span>
<span id="cb65-127"><a href="#cb65-127" aria-hidden="true" tabindex="-1"></a><span class="in">         x = "3pt%",</span></span>
<span id="cb65-128"><a href="#cb65-128" aria-hidden="true" tabindex="-1"></a><span class="in">         y = "Wins")</span></span>
<span id="cb65-129"><a href="#cb65-129" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-130"><a href="#cb65-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-131"><a href="#cb65-131" aria-hidden="true" tabindex="-1"></a><span class="fu">### Non-informative Prior Regression Model</span></span>
<span id="cb65-132"><a href="#cb65-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-133"><a href="#cb65-133" aria-hidden="true" tabindex="-1"></a>Let's consider the simple regression model $E(Y_i | X_i, \boldsymbol{\beta}, \sigma^2) = \beta_0 + \beta_1 X_i$ and $Var(Y_i | X_i = x_i, \boldsymbol{\beta}, \sigma^2) = \sigma^2$ <span class="co">[</span><span class="ot">@gelman2013bayesian, p. 354-358</span><span class="co">]</span>.</span>
<span id="cb65-134"><a href="#cb65-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-135"><a href="#cb65-135" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**The Prior:** $p(\boldsymbol{\beta}, \log\sigma) = 1 \equiv p(\boldsymbol{\beta}, \sigma^2) \propto \sigma^{-2}$</span>
<span id="cb65-136"><a href="#cb65-136" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**The (Data) Likelihood:** $\mathbf{Y} | \boldsymbol{\beta}, \sigma^2 \sim N_N(X\boldsymbol{\beta}, \sigma^2 I_N).$</span>
<span id="cb65-137"><a href="#cb65-137" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**The Posterior:**</span>
<span id="cb65-138"><a href="#cb65-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-139"><a href="#cb65-139" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb65-140"><a href="#cb65-140" aria-hidden="true" tabindex="-1"></a>    p(\boldsymbol{\beta}, \sigma^2 | \mathbf{y}) &amp;= p(\boldsymbol{\beta} | \sigma^2, \mathbf{y}) \times p(\sigma^2 | \mathbf{y}) <span class="sc">\\</span></span>
<span id="cb65-141"><a href="#cb65-141" aria-hidden="true" tabindex="-1"></a>        &amp;= N_2(\boldsymbol{\beta} | \hat{\boldsymbol{\beta}}, \sigma^2 (X'X)^{-1}) \times Inv-\chi^2 (\sigma^2 | N-2, s^2) <span class="sc">\\</span></span>
<span id="cb65-142"><a href="#cb65-142" aria-hidden="true" tabindex="-1"></a>    \hat{\boldsymbol{\beta}} &amp;= (X'X)^{-1} X'\mathbf{y} <span class="sc">\\</span></span>
<span id="cb65-143"><a href="#cb65-143" aria-hidden="true" tabindex="-1"></a>    s^2 &amp;= \frac{1}{N-2} (\mathbf{y} - X\hat{\boldsymbol{\beta}})' (\mathbf{y} - X\hat{\boldsymbol{\beta}})   </span>
<span id="cb65-144"><a href="#cb65-144" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb65-145"><a href="#cb65-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-146"><a href="#cb65-146" aria-hidden="true" tabindex="-1"></a>First we write the Stan code in a separate file. See the <span class="co">[</span><span class="ot">Stan User's Guide Part 1.1</span><span class="co">](https://mc-stan.org/docs/stan-users-guide/linear-regression.html#vectorization.section)</span> for programming this model without the analytic posteriors. (<span class="co">[</span><span class="ot">Download the file here</span><span class="co">](non-informative-regression.stan)</span>{target="_blank"})</span>
<span id="cb65-147"><a href="#cb65-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-148"><a href="#cb65-148" aria-hidden="true" tabindex="-1"></a><span class="in">``` {.stan filename="non-informative-regression.stan"}</span></span>
<span id="cb65-149"><a href="#cb65-149" aria-hidden="true" tabindex="-1"></a><span class="in">// The input data is two vectors 'y' and 'X' of length 'N'.</span></span>
<span id="cb65-150"><a href="#cb65-150" aria-hidden="true" tabindex="-1"></a><span class="in">data {</span></span>
<span id="cb65-151"><a href="#cb65-151" aria-hidden="true" tabindex="-1"></a><span class="in">  int&lt;lower=0&gt; N;</span></span>
<span id="cb65-152"><a href="#cb65-152" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[N] y;</span></span>
<span id="cb65-153"><a href="#cb65-153" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[N] x;</span></span>
<span id="cb65-154"><a href="#cb65-154" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb65-155"><a href="#cb65-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-156"><a href="#cb65-156" aria-hidden="true" tabindex="-1"></a><span class="in">transformed data {</span></span>
<span id="cb65-157"><a href="#cb65-157" aria-hidden="true" tabindex="-1"></a><span class="in">    matrix[N, 2] X_c = append_col(rep_vector(1, N), x);</span></span>
<span id="cb65-158"><a href="#cb65-158" aria-hidden="true" tabindex="-1"></a><span class="in">    matrix[2,2] XtX_inv = inverse(X_c' * X_c);</span></span>
<span id="cb65-159"><a href="#cb65-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-160"><a href="#cb65-160" aria-hidden="true" tabindex="-1"></a><span class="in">    vector[2] beta_hat = XtX_inv * X_c' * y;</span></span>
<span id="cb65-161"><a href="#cb65-161" aria-hidden="true" tabindex="-1"></a><span class="in">    vector[N] y_hat = X_C * beta_hat;</span></span>
<span id="cb65-162"><a href="#cb65-162" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb65-163"><a href="#cb65-163" aria-hidden="true" tabindex="-1"></a><span class="in">    real&lt;lower=0&gt; s_2 = 1 / (N - 2) * (y - y_hat)' * (y - y_hat);</span></span>
<span id="cb65-164"><a href="#cb65-164" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb65-165"><a href="#cb65-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-166"><a href="#cb65-166" aria-hidden="true" tabindex="-1"></a><span class="in">// The parameters accepted by the model. Our model</span></span>
<span id="cb65-167"><a href="#cb65-167" aria-hidden="true" tabindex="-1"></a><span class="in">// accepts two parameters 'beta' and 'sigma'.</span></span>
<span id="cb65-168"><a href="#cb65-168" aria-hidden="true" tabindex="-1"></a><span class="in">parameters {</span></span>
<span id="cb65-169"><a href="#cb65-169" aria-hidden="true" tabindex="-1"></a><span class="in">  vector beta;</span></span>
<span id="cb65-170"><a href="#cb65-170" aria-hidden="true" tabindex="-1"></a><span class="in">  real&lt;lower=0&gt; sigma; // Note that this is the variance</span></span>
<span id="cb65-171"><a href="#cb65-171" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb65-172"><a href="#cb65-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-173"><a href="#cb65-173" aria-hidden="true" tabindex="-1"></a><span class="in">// The model to be estimated. We model the output</span></span>
<span id="cb65-174"><a href="#cb65-174" aria-hidden="true" tabindex="-1"></a><span class="in">// 'y' ~ N(x beta, sigma) by specifying the analytic</span></span>
<span id="cb65-175"><a href="#cb65-175" aria-hidden="true" tabindex="-1"></a><span class="in">// posterior defined above.</span></span>
<span id="cb65-176"><a href="#cb65-176" aria-hidden="true" tabindex="-1"></a><span class="in">model {</span></span>
<span id="cb65-177"><a href="#cb65-177" aria-hidden="true" tabindex="-1"></a><span class="in">  beta ~ multi_normal(beta_hat, sigma^2 * XtX_inv);</span></span>
<span id="cb65-178"><a href="#cb65-178" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb65-179"><a href="#cb65-179" aria-hidden="true" tabindex="-1"></a><span class="in">  sigma^2 ~ scaled_inv_chi_square(N-2, sqrt(s_2));</span></span>
<span id="cb65-180"><a href="#cb65-180" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb65-181"><a href="#cb65-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-182"><a href="#cb65-182" aria-hidden="true" tabindex="-1"></a><span class="in">generated quantities {</span></span>
<span id="cb65-183"><a href="#cb65-183" aria-hidden="true" tabindex="-1"></a><span class="in">    vector[N] y_ppd;</span></span>
<span id="cb65-184"><a href="#cb65-184" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb65-185"><a href="#cb65-185" aria-hidden="true" tabindex="-1"></a><span class="in">    for (i in 1:N) {</span></span>
<span id="cb65-186"><a href="#cb65-186" aria-hidden="true" tabindex="-1"></a><span class="in">        y_ppd[i] = normal_rng(X_c[i,] * beta, sigma);</span></span>
<span id="cb65-187"><a href="#cb65-187" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb65-188"><a href="#cb65-188" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb65-189"><a href="#cb65-189" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-190"><a href="#cb65-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-191"><a href="#cb65-191" aria-hidden="true" tabindex="-1"></a>Next we fit the model using <span class="in">`cmdstanr`</span>. In this case, I will use 1000 warmup iterations, 1000 sampling iterations, with no thinning (thinning includes only every $k$th draw), and will refresh the print screen to see progress every 500 iterations. We can run several chains to see if where the chains start dictates any part of the posterior shape or location, and chains can be run in parallel to get more draws <span class="sc">\&lt;</span>=<span class="sc">\&gt;</span> better posterior approximation more quickly.</span>
<span id="cb65-192"><a href="#cb65-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-193"><a href="#cb65-193" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-194"><a href="#cb65-194" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: non-info-comp-fit</span></span>
<span id="cb65-195"><a href="#cb65-195" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-196"><a href="#cb65-196" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb65-197"><a href="#cb65-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-198"><a href="#cb65-198" aria-hidden="true" tabindex="-1"></a><span class="in">data_list &lt;- list(</span></span>
<span id="cb65-199"><a href="#cb65-199" aria-hidden="true" tabindex="-1"></a><span class="in">    N = nrow(ncaaw),</span></span>
<span id="cb65-200"><a href="#cb65-200" aria-hidden="true" tabindex="-1"></a><span class="in">    y = ncaaw$W,</span></span>
<span id="cb65-201"><a href="#cb65-201" aria-hidden="true" tabindex="-1"></a><span class="in">    x = ncaaw$FG3pct</span></span>
<span id="cb65-202"><a href="#cb65-202" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb65-203"><a href="#cb65-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-204"><a href="#cb65-204" aria-hidden="true" tabindex="-1"></a><span class="in">file &lt;- file.path("non-informative-regression.stan")</span></span>
<span id="cb65-205"><a href="#cb65-205" aria-hidden="true" tabindex="-1"></a><span class="in">non_inf_model &lt;- cmdstan_model(file)</span></span>
<span id="cb65-206"><a href="#cb65-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-207"><a href="#cb65-207" aria-hidden="true" tabindex="-1"></a><span class="in">fit1 &lt;- non_inf_model$sample(</span></span>
<span id="cb65-208"><a href="#cb65-208" aria-hidden="true" tabindex="-1"></a><span class="in">    data = data_list,</span></span>
<span id="cb65-209"><a href="#cb65-209" aria-hidden="true" tabindex="-1"></a><span class="in">    iter_warmup = 1000,</span></span>
<span id="cb65-210"><a href="#cb65-210" aria-hidden="true" tabindex="-1"></a><span class="in">    iter_sampling = 1000,</span></span>
<span id="cb65-211"><a href="#cb65-211" aria-hidden="true" tabindex="-1"></a><span class="in">    thin = 1,</span></span>
<span id="cb65-212"><a href="#cb65-212" aria-hidden="true" tabindex="-1"></a><span class="in">    refresh = 500,</span></span>
<span id="cb65-213"><a href="#cb65-213" aria-hidden="true" tabindex="-1"></a><span class="in">    chains = 2,</span></span>
<span id="cb65-214"><a href="#cb65-214" aria-hidden="true" tabindex="-1"></a><span class="in">    show_messages = TRUE,</span></span>
<span id="cb65-215"><a href="#cb65-215" aria-hidden="true" tabindex="-1"></a><span class="in">    show_exceptions = FALSE</span></span>
<span id="cb65-216"><a href="#cb65-216" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb65-217"><a href="#cb65-217" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-218"><a href="#cb65-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-219"><a href="#cb65-219" aria-hidden="true" tabindex="-1"></a>Next we'll check diagnostics for the sampler. First, we will look at the numeric diagnostic output from the method <span class="in">`$diagnostic_summary()`</span> which reports if any transitions were divergent, if maximum tree depth was reached, and EBFMI. For this model and data set we don't see any issues in these summaries.</span>
<span id="cb65-220"><a href="#cb65-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-221"><a href="#cb65-221" aria-hidden="true" tabindex="-1"></a>Next, we check the traceplots in @fig-traceplots-non-info-1. The MCMC draws can be collected from the <span class="in">`fit`</span> object using the <span class="in">`$draws()`</span> method. These plots display the sampled values for each parameter in a line plot. We are looking for a horizontal fuzzy bar. Then we can also look at density plots in @fig-traceplots-non-info-2 which will tell us if the chains reached reasonably similar densities. On both counts, we are in good shape. The plots are created using the <span class="in">`bayesplot`</span> package.</span>
<span id="cb65-222"><a href="#cb65-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-223"><a href="#cb65-223" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-224"><a href="#cb65-224" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: non-inf-summary</span></span>
<span id="cb65-225"><a href="#cb65-225" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-226"><a href="#cb65-226" aria-hidden="true" tabindex="-1"></a><span class="in">fit1$diagnostic_summary()</span></span>
<span id="cb65-227"><a href="#cb65-227" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-228"><a href="#cb65-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-229"><a href="#cb65-229" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-230"><a href="#cb65-230" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-traceplots-non-info</span></span>
<span id="cb65-231"><a href="#cb65-231" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-232"><a href="#cb65-232" aria-hidden="true" tabindex="-1"></a><span class="in">#| layout-ncol: 2</span></span>
<span id="cb65-233"><a href="#cb65-233" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Diagnostic plots for the posterior samples. Plots were made using the `bayesplot` package.</span></span>
<span id="cb65-234"><a href="#cb65-234" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-subcap: </span></span>
<span id="cb65-235"><a href="#cb65-235" aria-hidden="true" tabindex="-1"></a><span class="in">#|    - Traceplots for $\beta$ and $\sigma$.</span></span>
<span id="cb65-236"><a href="#cb65-236" aria-hidden="true" tabindex="-1"></a><span class="in">#|    - Approximate posterior densities for $\beta$ and $\sigma$.</span></span>
<span id="cb65-237"><a href="#cb65-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-238"><a href="#cb65-238" aria-hidden="true" tabindex="-1"></a><span class="in">library(bayesplot)</span></span>
<span id="cb65-239"><a href="#cb65-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-240"><a href="#cb65-240" aria-hidden="true" tabindex="-1"></a><span class="in">mcmc_trace(fit1$draws(variables = c("beta", "sigma")))</span></span>
<span id="cb65-241"><a href="#cb65-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-242"><a href="#cb65-242" aria-hidden="true" tabindex="-1"></a><span class="in">mcmc_dens_overlay(fit1$draws(variables = c("beta", "sigma")))</span></span>
<span id="cb65-243"><a href="#cb65-243" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-244"><a href="#cb65-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-245"><a href="#cb65-245" aria-hidden="true" tabindex="-1"></a>Finally, after checking that the MCMC chains and diagnostics look satisfactory, we can continue to inference. The summary statistics for the parameters are displayed in @tbl-non-info-inf. This are generated by default with the <span class="in">`$summary()`</span> method. The statistics include the posterior mean (<span class="in">`mean`</span>), median (<span class="in">`median`</span>), standard deviation (<span class="in">`sd`</span>), mean absolute deviation (<span class="in">`mad`</span>), and lower (<span class="in">`q5`</span>) and upper bounds (<span class="in">`q95`</span>) for a 90% credible interval. The statistics <span class="in">`rhat`</span>, <span class="in">`ess_bulk`</span>, and <span class="in">`ess_tail`</span> are additional diagnostic measures that indicate how well the chains are sampling the posterior and how many effective draws we have made. Ideally <span class="in">`rhat`</span> is very near 1, even 1.01 can be a significant problem. The effective sample sizes should be large/near the number of sampling iterations.</span>
<span id="cb65-246"><a href="#cb65-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-247"><a href="#cb65-247" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-248"><a href="#cb65-248" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: tbl-non-info-inf</span></span>
<span id="cb65-249"><a href="#cb65-249" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-250"><a href="#cb65-250" aria-hidden="true" tabindex="-1"></a><span class="in">#| tbl-cap: Summary statistics for the posterior samples for $\beta$ and $\sigma$.</span></span>
<span id="cb65-251"><a href="#cb65-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-252"><a href="#cb65-252" aria-hidden="true" tabindex="-1"></a><span class="in">fit1$summary(variables = c("beta", "sigma")) |&gt; </span></span>
<span id="cb65-253"><a href="#cb65-253" aria-hidden="true" tabindex="-1"></a><span class="in">    kableExtra::kbl(booktabs = TRUE, format = "html")</span></span>
<span id="cb65-254"><a href="#cb65-254" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-255"><a href="#cb65-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-256"><a href="#cb65-256" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-257"><a href="#cb65-257" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: tbl-mle-res-1</span></span>
<span id="cb65-258"><a href="#cb65-258" aria-hidden="true" tabindex="-1"></a><span class="in">#| output-location: column-fragment</span></span>
<span id="cb65-259"><a href="#cb65-259" aria-hidden="true" tabindex="-1"></a><span class="in">#| tbl-cap: MLE estimates for $\beta$ and $\sigma$.</span></span>
<span id="cb65-260"><a href="#cb65-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-261"><a href="#cb65-261" aria-hidden="true" tabindex="-1"></a><span class="in">mles |&gt; </span></span>
<span id="cb65-262"><a href="#cb65-262" aria-hidden="true" tabindex="-1"></a><span class="in">    kableExtra::kbl(booktabs = TRUE, </span></span>
<span id="cb65-263"><a href="#cb65-263" aria-hidden="true" tabindex="-1"></a><span class="in">                    format = "html", digits = 3)</span></span>
<span id="cb65-264"><a href="#cb65-264" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-265"><a href="#cb65-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-266"><a href="#cb65-266" aria-hidden="true" tabindex="-1"></a>We can also check graphical summaries of this same information such as interval plots for each parameter's credible intervals or density/area plots. In @fig-non-info-ci-1 we have the 50% (thick bar) and 95% (thin bar) credible intervals with the posterior mean displayed as a point. The densities are plotted in ridgelines in @fig-non-info-ci-2 with areas shaded underneath to indicate the 50% interval and the width of the density indicates the 95% interval.</span>
<span id="cb65-267"><a href="#cb65-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-268"><a href="#cb65-268" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-269"><a href="#cb65-269" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-non-info-ci</span></span>
<span id="cb65-270"><a href="#cb65-270" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-271"><a href="#cb65-271" aria-hidden="true" tabindex="-1"></a><span class="in">#| layout-ncol: 2</span></span>
<span id="cb65-272"><a href="#cb65-272" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Plots for the 50% Credible Interval (inner band) and 95% Credible Interval (outer band) for $\beta$ and $\sigma$. Plots were made using the `bayesplot` package.</span></span>
<span id="cb65-273"><a href="#cb65-273" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-subcap: </span></span>
<span id="cb65-274"><a href="#cb65-274" aria-hidden="true" tabindex="-1"></a><span class="in">#|    - Interval plots for $\beta$ and $\sigma$.</span></span>
<span id="cb65-275"><a href="#cb65-275" aria-hidden="true" tabindex="-1"></a><span class="in">#|    - Approximate posterior densities for $\beta$ and $\sigma$ in a ridgeline plot.</span></span>
<span id="cb65-276"><a href="#cb65-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-277"><a href="#cb65-277" aria-hidden="true" tabindex="-1"></a><span class="in">mcmc_intervals(fit1$draws(variables = c("beta", "sigma")))</span></span>
<span id="cb65-278"><a href="#cb65-278" aria-hidden="true" tabindex="-1"></a><span class="in">mcmc_areas_ridges(fit1$draws(variables = c("beta", "sigma")),</span></span>
<span id="cb65-279"><a href="#cb65-279" aria-hidden="true" tabindex="-1"></a><span class="in">                  prob_outer = 0.95, prob = 0.5)</span></span>
<span id="cb65-280"><a href="#cb65-280" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-281"><a href="#cb65-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-282"><a href="#cb65-282" aria-hidden="true" tabindex="-1"></a>One additional way to check model fit is to assess posterior predictive checks. To do so we draw samples from the posterior predictive distribution $p(y^{new} | y) = \int p(y^{new} | \boldsymbol{\beta}, \sigma) p(\boldsymbol{\beta}, \sigma | y) d\boldsymbol{\beta}d\sigma$ by first sampling from the posterior (i.e. the draws in the MCMC chains) and then for each set of draws sampling $y^{new}$ given the corresponding values for $x^{new}$. In Stan this is easily accomplished using the generated quantities block. The generated quantities block generates new samples that we define using the current iteration's posterior draws of $\beta$ and $\sigma$.</span>
<span id="cb65-283"><a href="#cb65-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-284"><a href="#cb65-284" aria-hidden="true" tabindex="-1"></a><span class="in">``` stan</span></span>
<span id="cb65-285"><a href="#cb65-285" aria-hidden="true" tabindex="-1"></a><span class="in">generated quantities {</span></span>
<span id="cb65-286"><a href="#cb65-286" aria-hidden="true" tabindex="-1"></a><span class="in">    // create a vector of N new observations</span></span>
<span id="cb65-287"><a href="#cb65-287" aria-hidden="true" tabindex="-1"></a><span class="in">    vector[N] y_ppd; </span></span>
<span id="cb65-288"><a href="#cb65-288" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb65-289"><a href="#cb65-289" aria-hidden="true" tabindex="-1"></a><span class="in">    // for each observation, sample from the regression likelihod</span></span>
<span id="cb65-290"><a href="#cb65-290" aria-hidden="true" tabindex="-1"></a><span class="in">    // using the posterior draws</span></span>
<span id="cb65-291"><a href="#cb65-291" aria-hidden="true" tabindex="-1"></a><span class="in">    for (i in 1:N) {</span></span>
<span id="cb65-292"><a href="#cb65-292" aria-hidden="true" tabindex="-1"></a><span class="in">        y_ppd[i] = normal_rng(X_c[i,] * beta, sigma);</span></span>
<span id="cb65-293"><a href="#cb65-293" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb65-294"><a href="#cb65-294" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb65-295"><a href="#cb65-295" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-296"><a href="#cb65-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-297"><a href="#cb65-297" aria-hidden="true" tabindex="-1"></a>We collect the PPD draws from the fit object using the draws method. From @fig-non-info-ppc we can see that while the predictive densities are centered in the correct location, the variances are far too large.</span>
<span id="cb65-298"><a href="#cb65-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-299"><a href="#cb65-299" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-300"><a href="#cb65-300" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-non-info-ppc</span></span>
<span id="cb65-301"><a href="#cb65-301" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-302"><a href="#cb65-302" aria-hidden="true" tabindex="-1"></a><span class="in">#| layout-ncol: 2</span></span>
<span id="cb65-303"><a href="#cb65-303" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Posterior Predictive Check plots from `bayesplot`.</span></span>
<span id="cb65-304"><a href="#cb65-304" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-subcap: </span></span>
<span id="cb65-305"><a href="#cb65-305" aria-hidden="true" tabindex="-1"></a><span class="in">#|     - PPD densities for the wins given 3pt%.</span></span>
<span id="cb65-306"><a href="#cb65-306" aria-hidden="true" tabindex="-1"></a><span class="in">#|     - PPD intervals for the wins plotted by 3pt%.</span></span>
<span id="cb65-307"><a href="#cb65-307" aria-hidden="true" tabindex="-1"></a><span class="in">library(posterior)</span></span>
<span id="cb65-308"><a href="#cb65-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-309"><a href="#cb65-309" aria-hidden="true" tabindex="-1"></a><span class="in">y_ppd &lt;- as.matrix(as_draws_df(fit1$draws(variables = "y_ppd")))</span></span>
<span id="cb65-310"><a href="#cb65-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-311"><a href="#cb65-311" aria-hidden="true" tabindex="-1"></a><span class="in">ppc_dens_overlay(ncaaw$W,</span></span>
<span id="cb65-312"><a href="#cb65-312" aria-hidden="true" tabindex="-1"></a><span class="in">                 y_ppd[1:50, 1:350]) +</span></span>
<span id="cb65-313"><a href="#cb65-313" aria-hidden="true" tabindex="-1"></a><span class="in">    labs(title = "Density of PPD Draws of NCAAW Wins",</span></span>
<span id="cb65-314"><a href="#cb65-314" aria-hidden="true" tabindex="-1"></a><span class="in">         x = "Wins")</span></span>
<span id="cb65-315"><a href="#cb65-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-316"><a href="#cb65-316" aria-hidden="true" tabindex="-1"></a><span class="in">ppc_intervals(ncaaw$W,</span></span>
<span id="cb65-317"><a href="#cb65-317" aria-hidden="true" tabindex="-1"></a><span class="in">                 y_ppd[1:50, 1:350],</span></span>
<span id="cb65-318"><a href="#cb65-318" aria-hidden="true" tabindex="-1"></a><span class="in">                 x = ncaaw$FG3pct) +</span></span>
<span id="cb65-319"><a href="#cb65-319" aria-hidden="true" tabindex="-1"></a><span class="in">    labs(title = "Density of PPD Draws of NCAAW Wins by 3pt%",</span></span>
<span id="cb65-320"><a href="#cb65-320" aria-hidden="true" tabindex="-1"></a><span class="in">         x = "3pt%",</span></span>
<span id="cb65-321"><a href="#cb65-321" aria-hidden="true" tabindex="-1"></a><span class="in">         y = "Wins")</span></span>
<span id="cb65-322"><a href="#cb65-322" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-323"><a href="#cb65-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-324"><a href="#cb65-324" aria-hidden="true" tabindex="-1"></a><span class="fu">### Conjugate Prior Regression Model</span></span>
<span id="cb65-325"><a href="#cb65-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-326"><a href="#cb65-326" aria-hidden="true" tabindex="-1"></a>Next, we'll implement the regression model with conjugate priors. Conjugacy refers to the situation where the prior and posterior distribution are from the same family. We'll start by re-defining our model.<span class="ot">[^1]</span></span>
<span id="cb65-327"><a href="#cb65-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-328"><a href="#cb65-328" aria-hidden="true" tabindex="-1"></a><span class="ot">[^1]: </span>See wikipedia for more details and derivations: <span class="ot">&lt;https://en.wikipedia.org/wiki/Bayesian_linear_regression&gt;</span></span>
<span id="cb65-329"><a href="#cb65-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-330"><a href="#cb65-330" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Conjugate prior:** $p(\boldsymbol{\beta}, \sigma^2) = p(\boldsymbol{\beta} | \sigma^2) p(\sigma^2)$</span>
<span id="cb65-331"><a href="#cb65-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-332"><a href="#cb65-332" aria-hidden="true" tabindex="-1"></a><span class="ss">    1.  </span>$\boldsymbol{\beta} | \sigma^2 ~ N_2(\boldsymbol{\beta}_0, \sigma^2 \Lambda_0^{-1})$ where $\boldsymbol{\beta}_0 \in \mathbb{R}^2$ is a vector of prior coefficients, we'll set it to zero, and $\Lambda_0$ is a $2\times2$ prior correlation matrix. We will set $\Lambda_0 = 10 I_2$ to get a weakly informative prior that is equivalent to ridge regression.</span>
<span id="cb65-333"><a href="#cb65-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-334"><a href="#cb65-334" aria-hidden="true" tabindex="-1"></a><span class="ss">    2.  </span>$\sigma^2 \sim InvGamma(\frac{\nu_0}{2}, \frac{1}{2} \nu_0 s_0^2)$ where $\nu_0$ is a prior sample size and $s_0$ is the prior standard deviation. We'll set these to $\nu_0 = 1$ and $s_0^2 = 47$ which is approximately the sample variance of the NCAA women's basketball teams' wins.</span>
<span id="cb65-335"><a href="#cb65-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-336"><a href="#cb65-336" aria-hidden="true" tabindex="-1"></a><span class="ss">    3.  </span>The parameters $\boldsymbol{\beta}_0, \Lambda_0, \nu_0, s_0^2$ that define the prior are referred to as hyperparameters. We will set them before running the model, although they could also be modeled if we wanted.</span>
<span id="cb65-337"><a href="#cb65-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-338"><a href="#cb65-338" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**The (Data) Likelihood:** the same as before, $\mathbf{Y} | \boldsymbol{\beta}, \sigma^2 \sim N_N(X\boldsymbol{\beta}, \sigma^2 I_N).$</span>
<span id="cb65-339"><a href="#cb65-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-340"><a href="#cb65-340" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Posterior:**</span>
<span id="cb65-341"><a href="#cb65-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-342"><a href="#cb65-342" aria-hidden="true" tabindex="-1"></a><span class="ss">    1.  </span>$\boldsymbol{\beta} | \sigma^2, y \sim N_2(\boldsymbol{\beta}_N, \sigma^2 \Lambda_N^{-1})$ where $\boldsymbol{\beta}_N = \Lambda_N^{-1}(\mathbf{X}'\mathbf{X} \hat{\boldsymbol{\beta}} + \Lambda_0 \boldsymbol{\beta}_0)$ and $\Lambda_N = (\mathbf{X}'\mathbf{X} + \Lambda_0).$</span>
<span id="cb65-343"><a href="#cb65-343" aria-hidden="true" tabindex="-1"></a><span class="ss">    2.  </span>$\sigma^2 | y \sim InvGamma(\sigma^2 | \frac{\nu_0 + N}{2}, \frac{1}{2} \nu_0 s_0^2 + \frac{1}{2}(\mathbf{y}'\mathbf{y} + \boldsymbol{\beta}_0'\Lambda_0 \boldsymbol{\beta}_0 - \boldsymbol{\beta}_N' \Lambda_N \boldsymbol{\beta}_N)).$</span>
<span id="cb65-344"><a href="#cb65-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-345"><a href="#cb65-345" aria-hidden="true" tabindex="-1"></a>We could again program this model using the analytic posterior. Instead, we'll program it only through the priors and likelihood and let Stan approximate the posterior. I will also allow the model to include more than one predictor so that $\mathbf{X}$ is a $N \times (K+1)$ matrix augmented with a column of ones. (<span class="co">[</span><span class="ot">Download the file here</span><span class="co">](conjugate-regression.stan)</span>{target="_blank"})</span>
<span id="cb65-346"><a href="#cb65-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-347"><a href="#cb65-347" aria-hidden="true" tabindex="-1"></a><span class="in">``` {.stan filename="conjugate-regression.stan"}</span></span>
<span id="cb65-348"><a href="#cb65-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-349"><a href="#cb65-349" aria-hidden="true" tabindex="-1"></a><span class="in">// The input data is a vector 'y' of length 'N'.</span></span>
<span id="cb65-350"><a href="#cb65-350" aria-hidden="true" tabindex="-1"></a><span class="in">data {</span></span>
<span id="cb65-351"><a href="#cb65-351" aria-hidden="true" tabindex="-1"></a><span class="in">  int&lt;lower=0&gt; N;</span></span>
<span id="cb65-352"><a href="#cb65-352" aria-hidden="true" tabindex="-1"></a><span class="in">  int&lt;lower=0&gt; K;</span></span>
<span id="cb65-353"><a href="#cb65-353" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[N] y;</span></span>
<span id="cb65-354"><a href="#cb65-354" aria-hidden="true" tabindex="-1"></a><span class="in">  matrix[N, K] X;</span></span>
<span id="cb65-355"><a href="#cb65-355" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb65-356"><a href="#cb65-356" aria-hidden="true" tabindex="-1"></a><span class="in">  // hyperparameters</span></span>
<span id="cb65-357"><a href="#cb65-357" aria-hidden="true" tabindex="-1"></a><span class="in">  real beta_0;</span></span>
<span id="cb65-358"><a href="#cb65-358" aria-hidden="true" tabindex="-1"></a><span class="in">  real&lt;lower=0&gt; lambda_0;</span></span>
<span id="cb65-359"><a href="#cb65-359" aria-hidden="true" tabindex="-1"></a><span class="in">  real&lt;lower=0&gt; nu_0;</span></span>
<span id="cb65-360"><a href="#cb65-360" aria-hidden="true" tabindex="-1"></a><span class="in">  real&lt;lower=0&gt; s_02;</span></span>
<span id="cb65-361"><a href="#cb65-361" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb65-362"><a href="#cb65-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-363"><a href="#cb65-363" aria-hidden="true" tabindex="-1"></a><span class="in">transformed data {</span></span>
<span id="cb65-364"><a href="#cb65-364" aria-hidden="true" tabindex="-1"></a><span class="in">    matrix[N, K+1] X_mat = append_col(rep_vector(1, N), X);</span></span>
<span id="cb65-365"><a href="#cb65-365" aria-hidden="true" tabindex="-1"></a><span class="in">    vector[K+1] beta_0_vec = rep_vector(beta_0, K+1);</span></span>
<span id="cb65-366"><a href="#cb65-366" aria-hidden="true" tabindex="-1"></a><span class="in">    matrix[K+1, K+1] Lambda_0 = lambda_0 * identity_matrix(K+1);</span></span>
<span id="cb65-367"><a href="#cb65-367" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb65-368"><a href="#cb65-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-369"><a href="#cb65-369" aria-hidden="true" tabindex="-1"></a><span class="in">// The parameters accepted by the model. Our model</span></span>
<span id="cb65-370"><a href="#cb65-370" aria-hidden="true" tabindex="-1"></a><span class="in">// accepts two parameters 'mu' and 'sigma'.</span></span>
<span id="cb65-371"><a href="#cb65-371" aria-hidden="true" tabindex="-1"></a><span class="in">parameters {</span></span>
<span id="cb65-372"><a href="#cb65-372" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[K+1] beta;</span></span>
<span id="cb65-373"><a href="#cb65-373" aria-hidden="true" tabindex="-1"></a><span class="in">  real&lt;lower=0&gt; sigma2;</span></span>
<span id="cb65-374"><a href="#cb65-374" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb65-375"><a href="#cb65-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-376"><a href="#cb65-376" aria-hidden="true" tabindex="-1"></a><span class="in">// The model to be estimated. We model the output</span></span>
<span id="cb65-377"><a href="#cb65-377" aria-hidden="true" tabindex="-1"></a><span class="in">// 'y' to be normally distributed with mean 'mu'</span></span>
<span id="cb65-378"><a href="#cb65-378" aria-hidden="true" tabindex="-1"></a><span class="in">// and standard deviation 'sigma'.</span></span>
<span id="cb65-379"><a href="#cb65-379" aria-hidden="true" tabindex="-1"></a><span class="in">model {</span></span>
<span id="cb65-380"><a href="#cb65-380" aria-hidden="true" tabindex="-1"></a><span class="in">  beta ~ multi_normal(beta_0_vec, sigma2 * Lambda_0);</span></span>
<span id="cb65-381"><a href="#cb65-381" aria-hidden="true" tabindex="-1"></a><span class="in">  sigma2 ~ scaled_inv_chi_square(nu_0, s_02);</span></span>
<span id="cb65-382"><a href="#cb65-382" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb65-383"><a href="#cb65-383" aria-hidden="true" tabindex="-1"></a><span class="in">  y ~ normal(X_mat * beta, sqrt(sigma2));</span></span>
<span id="cb65-384"><a href="#cb65-384" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb65-385"><a href="#cb65-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-386"><a href="#cb65-386" aria-hidden="true" tabindex="-1"></a><span class="in">generated quantities {</span></span>
<span id="cb65-387"><a href="#cb65-387" aria-hidden="true" tabindex="-1"></a><span class="in">    real sigma = sqrt(sigma2);</span></span>
<span id="cb65-388"><a href="#cb65-388" aria-hidden="true" tabindex="-1"></a><span class="in">    vector[N] y_ppd;</span></span>
<span id="cb65-389"><a href="#cb65-389" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb65-390"><a href="#cb65-390" aria-hidden="true" tabindex="-1"></a><span class="in">    for (i in 1:N) {</span></span>
<span id="cb65-391"><a href="#cb65-391" aria-hidden="true" tabindex="-1"></a><span class="in">        y_ppd[i] = normal_rng(X_mat[i,] * beta, sqrt(sigma2));</span></span>
<span id="cb65-392"><a href="#cb65-392" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb65-393"><a href="#cb65-393" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb65-394"><a href="#cb65-394" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-395"><a href="#cb65-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-396"><a href="#cb65-396" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-397"><a href="#cb65-397" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: conj-comp-fit</span></span>
<span id="cb65-398"><a href="#cb65-398" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-399"><a href="#cb65-399" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb65-400"><a href="#cb65-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-401"><a href="#cb65-401" aria-hidden="true" tabindex="-1"></a><span class="in">data_list2 &lt;- list(</span></span>
<span id="cb65-402"><a href="#cb65-402" aria-hidden="true" tabindex="-1"></a><span class="in">    N = nrow(ncaaw),</span></span>
<span id="cb65-403"><a href="#cb65-403" aria-hidden="true" tabindex="-1"></a><span class="in">    K = 1,</span></span>
<span id="cb65-404"><a href="#cb65-404" aria-hidden="true" tabindex="-1"></a><span class="in">    y = ncaaw$W,</span></span>
<span id="cb65-405"><a href="#cb65-405" aria-hidden="true" tabindex="-1"></a><span class="in">    X = as.matrix(ncaaw$FG3pct, nrow = nrow(ncaaw)),</span></span>
<span id="cb65-406"><a href="#cb65-406" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb65-407"><a href="#cb65-407" aria-hidden="true" tabindex="-1"></a><span class="in">    # hyperparameters</span></span>
<span id="cb65-408"><a href="#cb65-408" aria-hidden="true" tabindex="-1"></a><span class="in">    beta_0 = 0,</span></span>
<span id="cb65-409"><a href="#cb65-409" aria-hidden="true" tabindex="-1"></a><span class="in">    lambda_0 = 0.5,</span></span>
<span id="cb65-410"><a href="#cb65-410" aria-hidden="true" tabindex="-1"></a><span class="in">    nu_0 = 1,</span></span>
<span id="cb65-411"><a href="#cb65-411" aria-hidden="true" tabindex="-1"></a><span class="in">    s_02 = 47</span></span>
<span id="cb65-412"><a href="#cb65-412" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb65-413"><a href="#cb65-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-414"><a href="#cb65-414" aria-hidden="true" tabindex="-1"></a><span class="in">file2 &lt;- file.path("conjugate-regression.stan")</span></span>
<span id="cb65-415"><a href="#cb65-415" aria-hidden="true" tabindex="-1"></a><span class="in">conj_model &lt;- cmdstan_model(file2)</span></span>
<span id="cb65-416"><a href="#cb65-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-417"><a href="#cb65-417" aria-hidden="true" tabindex="-1"></a><span class="in">fit2 &lt;- conj_model$sample(</span></span>
<span id="cb65-418"><a href="#cb65-418" aria-hidden="true" tabindex="-1"></a><span class="in">    data = data_list2,</span></span>
<span id="cb65-419"><a href="#cb65-419" aria-hidden="true" tabindex="-1"></a><span class="in">    iter_warmup = 1000,</span></span>
<span id="cb65-420"><a href="#cb65-420" aria-hidden="true" tabindex="-1"></a><span class="in">    iter_sampling = 1000,</span></span>
<span id="cb65-421"><a href="#cb65-421" aria-hidden="true" tabindex="-1"></a><span class="in">    thin = 1,</span></span>
<span id="cb65-422"><a href="#cb65-422" aria-hidden="true" tabindex="-1"></a><span class="in">    refresh = 500,</span></span>
<span id="cb65-423"><a href="#cb65-423" aria-hidden="true" tabindex="-1"></a><span class="in">    chains = 2,</span></span>
<span id="cb65-424"><a href="#cb65-424" aria-hidden="true" tabindex="-1"></a><span class="in">    show_messages = TRUE,</span></span>
<span id="cb65-425"><a href="#cb65-425" aria-hidden="true" tabindex="-1"></a><span class="in">    show_exceptions = FALSE</span></span>
<span id="cb65-426"><a href="#cb65-426" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb65-427"><a href="#cb65-427" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-428"><a href="#cb65-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-429"><a href="#cb65-429" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-430"><a href="#cb65-430" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: conj-summary</span></span>
<span id="cb65-431"><a href="#cb65-431" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-432"><a href="#cb65-432" aria-hidden="true" tabindex="-1"></a><span class="in">fit2$diagnostic_summary()</span></span>
<span id="cb65-433"><a href="#cb65-433" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-434"><a href="#cb65-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-435"><a href="#cb65-435" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-436"><a href="#cb65-436" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-traceplots-conj</span></span>
<span id="cb65-437"><a href="#cb65-437" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-438"><a href="#cb65-438" aria-hidden="true" tabindex="-1"></a><span class="in">#| layout-ncol: 2</span></span>
<span id="cb65-439"><a href="#cb65-439" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Diagnostic plots for the posterior samples. Plots were made using the `bayesplot` package.</span></span>
<span id="cb65-440"><a href="#cb65-440" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-subcap: </span></span>
<span id="cb65-441"><a href="#cb65-441" aria-hidden="true" tabindex="-1"></a><span class="in">#|    - Traceplots for $\beta$ and $\sigma$.</span></span>
<span id="cb65-442"><a href="#cb65-442" aria-hidden="true" tabindex="-1"></a><span class="in">#|    - Approximate posterior densities for $\beta$ and $\sigma$.</span></span>
<span id="cb65-443"><a href="#cb65-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-444"><a href="#cb65-444" aria-hidden="true" tabindex="-1"></a><span class="in">mcmc_trace(fit2$draws(variables = c("beta", "sigma")))</span></span>
<span id="cb65-445"><a href="#cb65-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-446"><a href="#cb65-446" aria-hidden="true" tabindex="-1"></a><span class="in">mcmc_dens_overlay(fit2$draws(variables = c("beta", "sigma")))</span></span>
<span id="cb65-447"><a href="#cb65-447" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-448"><a href="#cb65-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-449"><a href="#cb65-449" aria-hidden="true" tabindex="-1"></a>Again the MCMC chains and diagnostics look satisfactory. The summary statistics for the parameters are displayed in @tbl-conj-inf.</span>
<span id="cb65-450"><a href="#cb65-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-451"><a href="#cb65-451" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-452"><a href="#cb65-452" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: tbl-conj-inf</span></span>
<span id="cb65-453"><a href="#cb65-453" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-454"><a href="#cb65-454" aria-hidden="true" tabindex="-1"></a><span class="in">#| tbl-cap: Summary statistics for the posterior samples for $\beta$ and $\sigma$.</span></span>
<span id="cb65-455"><a href="#cb65-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-456"><a href="#cb65-456" aria-hidden="true" tabindex="-1"></a><span class="in">fit2$summary(variables = c("beta", "sigma")) |&gt; </span></span>
<span id="cb65-457"><a href="#cb65-457" aria-hidden="true" tabindex="-1"></a><span class="in">    kableExtra::kbl(booktabs = TRUE, format = "html")</span></span>
<span id="cb65-458"><a href="#cb65-458" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-459"><a href="#cb65-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-460"><a href="#cb65-460" aria-hidden="true" tabindex="-1"></a>And here's a quick reminder of our results for the non-informative prior and MLE fits in @tbl-fit-comp.</span>
<span id="cb65-461"><a href="#cb65-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-462"><a href="#cb65-462" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-463"><a href="#cb65-463" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: tbl-fit-comp</span></span>
<span id="cb65-464"><a href="#cb65-464" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-465"><a href="#cb65-465" aria-hidden="true" tabindex="-1"></a><span class="in">#| tbl-cap: Comparison of the estimates for $\beta$ and $\sigma$.</span></span>
<span id="cb65-466"><a href="#cb65-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-467"><a href="#cb65-467" aria-hidden="true" tabindex="-1"></a><span class="in">mcmc_summary &lt;- cbind(mles,</span></span>
<span id="cb65-468"><a href="#cb65-468" aria-hidden="true" tabindex="-1"></a><span class="in">  fit1$summary(variables = c("beta", "sigma"))[,c("mean", "sd")])</span></span>
<span id="cb65-469"><a href="#cb65-469" aria-hidden="true" tabindex="-1"></a><span class="in">mcmc_summary &lt;- cbind(mcmc_summary,</span></span>
<span id="cb65-470"><a href="#cb65-470" aria-hidden="true" tabindex="-1"></a><span class="in">  fit2$summary(variables = c("beta", "sigma"))[,c("mean", "sd")])</span></span>
<span id="cb65-471"><a href="#cb65-471" aria-hidden="true" tabindex="-1"></a><span class="in">colnames(mcmc_summary) &lt;- c("Variable", "MLE", "Non-info Est", "Non-info SD", "Conj Est", "Conj SD")</span></span>
<span id="cb65-472"><a href="#cb65-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-473"><a href="#cb65-473" aria-hidden="true" tabindex="-1"></a><span class="in">mcmc_summary |&gt;</span></span>
<span id="cb65-474"><a href="#cb65-474" aria-hidden="true" tabindex="-1"></a><span class="in">    kableExtra::kbl(booktabs = TRUE, format = "html", digits = 3)</span></span>
<span id="cb65-475"><a href="#cb65-475" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-476"><a href="#cb65-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-477"><a href="#cb65-477" aria-hidden="true" tabindex="-1"></a>In @fig-conj-ci-1 we have the 50% and 95% CIs with the posterior mean displayed as a point. The densities are plotted in ridgelines in @fig-conj-ci-2.</span>
<span id="cb65-478"><a href="#cb65-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-479"><a href="#cb65-479" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-480"><a href="#cb65-480" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-conj-ci</span></span>
<span id="cb65-481"><a href="#cb65-481" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-482"><a href="#cb65-482" aria-hidden="true" tabindex="-1"></a><span class="in">#| layout-ncol: 2</span></span>
<span id="cb65-483"><a href="#cb65-483" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Plots for the 50% Credible Interval (inner band) and 95% Credible Interval (outer band) for $\beta$ and $\sigma$. Plots were made using the `bayesplot` package.</span></span>
<span id="cb65-484"><a href="#cb65-484" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-subcap: </span></span>
<span id="cb65-485"><a href="#cb65-485" aria-hidden="true" tabindex="-1"></a><span class="in">#|    - Interval plots for $\beta$ and $\sigma$.</span></span>
<span id="cb65-486"><a href="#cb65-486" aria-hidden="true" tabindex="-1"></a><span class="in">#|    - Approximate posterior densities for $\beta$ and $\sigma$ in a ridgeline plot.</span></span>
<span id="cb65-487"><a href="#cb65-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-488"><a href="#cb65-488" aria-hidden="true" tabindex="-1"></a><span class="in">mcmc_intervals(fit2$draws(variables = c("beta", "sigma")))</span></span>
<span id="cb65-489"><a href="#cb65-489" aria-hidden="true" tabindex="-1"></a><span class="in">mcmc_areas_ridges(fit2$draws(variables = c("beta", "sigma")),</span></span>
<span id="cb65-490"><a href="#cb65-490" aria-hidden="true" tabindex="-1"></a><span class="in">                  prob_outer = 0.95, prob = 0.5)</span></span>
<span id="cb65-491"><a href="#cb65-491" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-492"><a href="#cb65-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-493"><a href="#cb65-493" aria-hidden="true" tabindex="-1"></a>We collect the PPD draws from the fit object using the draws method. From @fig-conj-ppc we can see that while the predictive densities match pretty well and the intervals are centered on the OLS line of best fit.</span>
<span id="cb65-494"><a href="#cb65-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-495"><a href="#cb65-495" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-496"><a href="#cb65-496" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-conj-ppc</span></span>
<span id="cb65-497"><a href="#cb65-497" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-498"><a href="#cb65-498" aria-hidden="true" tabindex="-1"></a><span class="in">#| layout-ncol: 2</span></span>
<span id="cb65-499"><a href="#cb65-499" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Posterior Predictive Check plots from `bayesplot`.</span></span>
<span id="cb65-500"><a href="#cb65-500" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-subcap: </span></span>
<span id="cb65-501"><a href="#cb65-501" aria-hidden="true" tabindex="-1"></a><span class="in">#|     - PPD densities for the wins given 3pt%.</span></span>
<span id="cb65-502"><a href="#cb65-502" aria-hidden="true" tabindex="-1"></a><span class="in">#|     - PPD intervals for the wins plotted by 3pt%.</span></span>
<span id="cb65-503"><a href="#cb65-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-504"><a href="#cb65-504" aria-hidden="true" tabindex="-1"></a><span class="in">y_ppd &lt;- as.matrix(as_draws_df(fit2$draws(variables = "y_ppd")))</span></span>
<span id="cb65-505"><a href="#cb65-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-506"><a href="#cb65-506" aria-hidden="true" tabindex="-1"></a><span class="in">ppc_dens_overlay(ncaaw$W,</span></span>
<span id="cb65-507"><a href="#cb65-507" aria-hidden="true" tabindex="-1"></a><span class="in">                 y_ppd[1:50, 1:350]) +</span></span>
<span id="cb65-508"><a href="#cb65-508" aria-hidden="true" tabindex="-1"></a><span class="in">    labs(title = "Density of PPD Draws of NCAAW Wins",</span></span>
<span id="cb65-509"><a href="#cb65-509" aria-hidden="true" tabindex="-1"></a><span class="in">         x = "Wins")</span></span>
<span id="cb65-510"><a href="#cb65-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-511"><a href="#cb65-511" aria-hidden="true" tabindex="-1"></a><span class="in">ppc_intervals(ncaaw$W,</span></span>
<span id="cb65-512"><a href="#cb65-512" aria-hidden="true" tabindex="-1"></a><span class="in">                 y_ppd[1:50, 1:350],</span></span>
<span id="cb65-513"><a href="#cb65-513" aria-hidden="true" tabindex="-1"></a><span class="in">                 x = ncaaw$FG3pct) +</span></span>
<span id="cb65-514"><a href="#cb65-514" aria-hidden="true" tabindex="-1"></a><span class="in">    labs(title = "Density of PPD Draws of NCAAW Wins by 3pt%",</span></span>
<span id="cb65-515"><a href="#cb65-515" aria-hidden="true" tabindex="-1"></a><span class="in">         x = "3pt%",</span></span>
<span id="cb65-516"><a href="#cb65-516" aria-hidden="true" tabindex="-1"></a><span class="in">         y = "Wins")</span></span>
<span id="cb65-517"><a href="#cb65-517" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-518"><a href="#cb65-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-519"><a href="#cb65-519" aria-hidden="true" tabindex="-1"></a><span class="fu">## Some Other Useful Resources for Stan</span></span>
<span id="cb65-520"><a href="#cb65-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-521"><a href="#cb65-521" aria-hidden="true" tabindex="-1"></a>First, here's the three essential guides for using Stan:</span>
<span id="cb65-522"><a href="#cb65-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-523"><a href="#cb65-523" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Stan Function Guide</span><span class="co">](https://mc-stan.org/docs/functions-reference/index.html)</span> - reference for all the built-in functions and distributions as well as guides for writing custom functions and distributions</span>
<span id="cb65-524"><a href="#cb65-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-525"><a href="#cb65-525" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Stan User's Guide</span><span class="co">](https://mc-stan.org/docs/stan-users-guide/index.html)</span> - reference for example models, how to build efficient models, and some inference techniques</span>
<span id="cb65-526"><a href="#cb65-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-527"><a href="#cb65-527" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Stan Reference Manual</span><span class="co">](https://mc-stan.org/docs/reference-manual/index.html)</span> - reference for programming in Stan with a focus on how the language works</span>
<span id="cb65-528"><a href="#cb65-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-529"><a href="#cb65-529" aria-hidden="true" tabindex="-1"></a>Here are some other useful packages to use for Bayesian data analysis with Stan (or other packages). We used some of these in this tutorial!</span>
<span id="cb65-530"><a href="#cb65-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-531"><a href="#cb65-531" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">brms</span><span class="co">](https://paul-buerkner.github.io/brms/index.html)</span>: Bayesian regression models using Stan</span>
<span id="cb65-532"><a href="#cb65-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-533"><a href="#cb65-533" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">posterior</span><span class="co">](https://mc-stan.org/posterior/)</span>: Useful for working with Stan output</span>
<span id="cb65-534"><a href="#cb65-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-535"><a href="#cb65-535" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">bayesplot</span><span class="co">](http://mc-stan.org/bayesplot)</span>: ggplot2-based plotting functions for MCMC draws designed work well with Stan</span>
<span id="cb65-536"><a href="#cb65-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-537"><a href="#cb65-537" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">loo</span><span class="co">](http://mc-stan.org/loo)</span>: Leave-one-out cross validation for model checking and selection that works with the log-posterior. Works best with <span class="in">`rstanarm`</span> but can work with <span class="in">`cmdstanr`</span> too.</span>
<span id="cb65-538"><a href="#cb65-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-539"><a href="#cb65-539" aria-hidden="true" tabindex="-1"></a>Here's a list of useful resources for debugging issues with divergences, hitting maximum tree-depth, low EBFMI, and understanding diagnostics:</span>
<span id="cb65-540"><a href="#cb65-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-541"><a href="#cb65-541" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Stan's Guide to Runtime warnings and convergence problems</span><span class="co">](https://mc-stan.org/misc/warnings.html)</span></span>
<span id="cb65-542"><a href="#cb65-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-543"><a href="#cb65-543" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Prior Choices and Selection</span><span class="co">](https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations)</span></span>
<span id="cb65-544"><a href="#cb65-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-545"><a href="#cb65-545" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Convergence Diagnostics for MCMC</span><span class="co">](https://arxiv.org/pdf/1909.11827.pdf)</span></span>
<span id="cb65-546"><a href="#cb65-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-547"><a href="#cb65-547" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Official Stan Forum</span><span class="co">](https://discourse.mc-stan.org/)</span></span>
<span id="cb65-548"><a href="#cb65-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-549"><a href="#cb65-549" aria-hidden="true" tabindex="-1"></a><span class="fu">## Bonus: Regression Modeling with Incomplete Data</span></span>
<span id="cb65-550"><a href="#cb65-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-551"><a href="#cb65-551" aria-hidden="true" tabindex="-1"></a>As a bonus section, we'll use the <span class="in">`brms`</span> package to fit a regression model where we have incomplete predictor observations. Incomplete data analysis ranges from complete case analysis (incomplete cases are dropped) and mean imputation to multiple imputation, joint modeling, and EM algorithm <span class="co">[</span><span class="ot">@schafer2002</span><span class="co">]</span>.<span class="ot">[^2]</span> We're going to use <span class="in">`mice`</span> <span class="co">[</span><span class="ot">@buuren2010mice</span><span class="co">]</span> and <span class="in">`brms`</span> <span class="co">[</span><span class="ot">@bürkner2018</span><span class="co">]</span> to demonstrate the imputation and fitting Bayesian regression models with a convenient front-end that writes the Stan code for us.</span>
<span id="cb65-552"><a href="#cb65-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-553"><a href="#cb65-553" aria-hidden="true" tabindex="-1"></a><span class="ot">[^2]: </span>See <span class="co">[</span><span class="ot">@rubin1976, @dempster1977, @rubin1987, @harel2007multiple, @white2011</span><span class="co">]</span> for more details on incomplete data analysis.</span>
<span id="cb65-554"><a href="#cb65-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-555"><a href="#cb65-555" aria-hidden="true" tabindex="-1"></a>In our case, we are going to use junior year scoring (points per game) to predict senior year scoring for women's college basketball players from 2020-21 to the 2022-23 seasons. The data set only contains players who played in at least 75% of games each season, so partial seasons due to injury or being a bench player are excluded. Players who only have a junior season are excluded from the analysis.</span>
<span id="cb65-556"><a href="#cb65-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-557"><a href="#cb65-557" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-558"><a href="#cb65-558" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: load-ncaaw-i</span></span>
<span id="cb65-559"><a href="#cb65-559" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-560"><a href="#cb65-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-561"><a href="#cb65-561" aria-hidden="true" tabindex="-1"></a><span class="in">ncaaw_i &lt;- read.csv("Data/ncaaw-individuals.csv", header = TRUE)</span></span>
<span id="cb65-562"><a href="#cb65-562" aria-hidden="true" tabindex="-1"></a><span class="in">head(ncaaw_i)</span></span>
<span id="cb65-563"><a href="#cb65-563" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-564"><a href="#cb65-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-565"><a href="#cb65-565" aria-hidden="true" tabindex="-1"></a>Our imputation model will be univariate linear regression that use all other variables as predictors. For example, imputing $PPG_{jr}$ will be done by regressing on $PPG_{sr}, G_{jr}, G_{sr}$. $PPG_{jr}$ and $G_{jr}$ are incomplete for $n_{mis} = 176$ players while $n_{obs} = 98$ players have stats from both years. This missing data pattern is displayed in @fig-miss-patt.</span>
<span id="cb65-566"><a href="#cb65-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-567"><a href="#cb65-567" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-568"><a href="#cb65-568" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-miss-patt</span></span>
<span id="cb65-569"><a href="#cb65-569" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-570"><a href="#cb65-570" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Missing data patterns for the NCAA women's basketball players from 2020-2023 who played in their junior and senior year. The red boxes correspond to missing values, so there are 176 players who recorded full senior seasons (played in &gt;75% of total games) but missing or shortened junior seasons.</span></span>
<span id="cb65-571"><a href="#cb65-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-572"><a href="#cb65-572" aria-hidden="true" tabindex="-1"></a><span class="in">library(mice)</span></span>
<span id="cb65-573"><a href="#cb65-573" aria-hidden="true" tabindex="-1"></a><span class="in">m_pat &lt;- md.pattern(ncaaw_i, plot = TRUE)</span></span>
<span id="cb65-574"><a href="#cb65-574" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-575"><a href="#cb65-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-576"><a href="#cb65-576" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-577"><a href="#cb65-577" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-ppg-jr-sr</span></span>
<span id="cb65-578"><a href="#cb65-578" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-579"><a href="#cb65-579" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Points per game (PPG) from Junior and Senior seasons.</span></span>
<span id="cb65-580"><a href="#cb65-580" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb65-581"><a href="#cb65-581" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(ncaaw_i, aes(PPG_jr, PPG_sr, color = G_jr)) +</span></span>
<span id="cb65-582"><a href="#cb65-582" aria-hidden="true" tabindex="-1"></a><span class="in">    geom_point() +</span></span>
<span id="cb65-583"><a href="#cb65-583" aria-hidden="true" tabindex="-1"></a><span class="in">    scale_color_viridis_c(name = "G - Jr") +</span></span>
<span id="cb65-584"><a href="#cb65-584" aria-hidden="true" tabindex="-1"></a><span class="in">    labs(x = "PPG - Jr",</span></span>
<span id="cb65-585"><a href="#cb65-585" aria-hidden="true" tabindex="-1"></a><span class="in">         y = "PPG - Sr") +</span></span>
<span id="cb65-586"><a href="#cb65-586" aria-hidden="true" tabindex="-1"></a><span class="in">    theme_bw()</span></span>
<span id="cb65-587"><a href="#cb65-587" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-588"><a href="#cb65-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-589"><a href="#cb65-589" aria-hidden="true" tabindex="-1"></a><span class="fu">### Multiple Imputation with mice</span></span>
<span id="cb65-590"><a href="#cb65-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-591"><a href="#cb65-591" aria-hidden="true" tabindex="-1"></a>First, we'll try out imputing before model fitting using <span class="in">`mice`</span>. MICE stands for Multiple Imputation by Chained Equations and is procedure that creates a set of $M$ completed data sets from an incomplete data set. Multiple Imputation is a three stage procedure:</span>
<span id="cb65-592"><a href="#cb65-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-593"><a href="#cb65-593" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Each incomplete variable is imputed with posterior predictive draws from a regression model with all other variables as predictors. The procedure iterates through the incomplete variables several times to converge to the posterior predictive distribution of the missing data given the observed.</span>
<span id="cb65-594"><a href="#cb65-594" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>These completed data sets are then analyzed individually with a standard complete data method.</span>
<span id="cb65-595"><a href="#cb65-595" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Results from each analysis are combined. Typically this is done with Rubin's rules <span class="co">[</span><span class="ot">@rubin1987</span><span class="co">]</span>, but <span class="in">`brms`</span> follows the advice of @zhou2010 and simply stacks the posterior draw matrices from each fitted model.</span>
<span id="cb65-596"><a href="#cb65-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-597"><a href="#cb65-597" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-598"><a href="#cb65-598" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: mice-fit</span></span>
<span id="cb65-599"><a href="#cb65-599" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-600"><a href="#cb65-600" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb65-601"><a href="#cb65-601" aria-hidden="true" tabindex="-1"></a><span class="in">#| cache: true</span></span>
<span id="cb65-602"><a href="#cb65-602" aria-hidden="true" tabindex="-1"></a><span class="in">library(brms)</span></span>
<span id="cb65-603"><a href="#cb65-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-604"><a href="#cb65-604" aria-hidden="true" tabindex="-1"></a><span class="in">imps &lt;- mice(ncaaw_i, m = 10, method = "norm", maxit = 10, printFlag = FALSE)</span></span>
<span id="cb65-605"><a href="#cb65-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-606"><a href="#cb65-606" aria-hidden="true" tabindex="-1"></a><span class="in">fit_brm_mice &lt;- brm_multiple(PPG_sr ~ G_jr * PPG_jr, data = imps, chains = 2,</span></span>
<span id="cb65-607"><a href="#cb65-607" aria-hidden="true" tabindex="-1"></a><span class="in">                             refresh = 0)</span></span>
<span id="cb65-608"><a href="#cb65-608" aria-hidden="true" tabindex="-1"></a><span class="in">summary(fit_brm_mice)</span></span>
<span id="cb65-609"><a href="#cb65-609" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-610"><a href="#cb65-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-611"><a href="#cb65-611" aria-hidden="true" tabindex="-1"></a><span class="fu">### Imputation During Model Fitting</span></span>
<span id="cb65-612"><a href="#cb65-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-613"><a href="#cb65-613" aria-hidden="true" tabindex="-1"></a>Imputation during model fitting takes a different approach. Imputations are made for each incomplete variable using a different conditional model for each variable. This approach differs from MI and MICE in two key ways: (i) the model is only fit once since the imputation model is part of the analysis model, (ii) the model must be constructed uniquely for each analysis scenario whereas MI completed data sets can be re-used with different analyses.</span>
<span id="cb65-614"><a href="#cb65-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-615"><a href="#cb65-615" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-616"><a href="#cb65-616" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: brm-mi-fit</span></span>
<span id="cb65-617"><a href="#cb65-617" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-618"><a href="#cb65-618" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb65-619"><a href="#cb65-619" aria-hidden="true" tabindex="-1"></a><span class="in">#| cache: true</span></span>
<span id="cb65-620"><a href="#cb65-620" aria-hidden="true" tabindex="-1"></a><span class="in">bform &lt;- bf(PPG_sr | mi() ~ mi(G_jr) * mi(PPG_jr)) +</span></span>
<span id="cb65-621"><a href="#cb65-621" aria-hidden="true" tabindex="-1"></a><span class="in">    bf(PPG_jr | mi() ~ G_sr + PPG_sr) +</span></span>
<span id="cb65-622"><a href="#cb65-622" aria-hidden="true" tabindex="-1"></a><span class="in">    bf(G_jr | mi() ~ G_sr + PPG_sr) + set_rescor(FALSE)</span></span>
<span id="cb65-623"><a href="#cb65-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-624"><a href="#cb65-624" aria-hidden="true" tabindex="-1"></a><span class="in">fit_brm_mi &lt;- brm(bform, data = ncaaw_i, </span></span>
<span id="cb65-625"><a href="#cb65-625" aria-hidden="true" tabindex="-1"></a><span class="in">                  refresh = 500, iter = 2000, thin = 1,</span></span>
<span id="cb65-626"><a href="#cb65-626" aria-hidden="true" tabindex="-1"></a><span class="in">                  backend = "cmdstanr", </span></span>
<span id="cb65-627"><a href="#cb65-627" aria-hidden="true" tabindex="-1"></a><span class="in">                  control = list(adapt_delta = 0.8, </span></span>
<span id="cb65-628"><a href="#cb65-628" aria-hidden="true" tabindex="-1"></a><span class="in">                                 max_depth = 10,</span></span>
<span id="cb65-629"><a href="#cb65-629" aria-hidden="true" tabindex="-1"></a><span class="in">                                show_exceptions = FALSE),</span></span>
<span id="cb65-630"><a href="#cb65-630" aria-hidden="true" tabindex="-1"></a><span class="in">                  chains = 2,</span></span>
<span id="cb65-631"><a href="#cb65-631" aria-hidden="true" tabindex="-1"></a><span class="in">                  cores = 2)</span></span>
<span id="cb65-632"><a href="#cb65-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-633"><a href="#cb65-633" aria-hidden="true" tabindex="-1"></a><span class="in">summary(fit_brm_mi)</span></span>
<span id="cb65-634"><a href="#cb65-634" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-635"><a href="#cb65-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-636"><a href="#cb65-636" aria-hidden="true" tabindex="-1"></a><span class="in">`brms`</span> is built on Stan, so we can also take a look at the traceplots of the samples in @fig-brm-mi-trace.</span>
<span id="cb65-637"><a href="#cb65-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-638"><a href="#cb65-638" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-639"><a href="#cb65-639" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-brm-mi-trace</span></span>
<span id="cb65-640"><a href="#cb65-640" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-641"><a href="#cb65-641" aria-hidden="true" tabindex="-1"></a><span class="in">#| layout-nrow: 2</span></span>
<span id="cb65-642"><a href="#cb65-642" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Traceplots of brms analysis model parameters.</span></span>
<span id="cb65-643"><a href="#cb65-643" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-subcap: </span></span>
<span id="cb65-644"><a href="#cb65-644" aria-hidden="true" tabindex="-1"></a><span class="in">#|   - ""</span></span>
<span id="cb65-645"><a href="#cb65-645" aria-hidden="true" tabindex="-1"></a><span class="in">#|   - ""</span></span>
<span id="cb65-646"><a href="#cb65-646" aria-hidden="true" tabindex="-1"></a><span class="in">plot(fit_brm_mi, variable = c("b_PPGsr", "bsp_"), regex = TRUE, ask = FALSE, N = 3)</span></span>
<span id="cb65-647"><a href="#cb65-647" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-648"><a href="#cb65-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-649"><a href="#cb65-649" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-650"><a href="#cb65-650" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-brm-mi-trace-imp</span></span>
<span id="cb65-651"><a href="#cb65-651" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-652"><a href="#cb65-652" aria-hidden="true" tabindex="-1"></a><span class="in">#| layout-nrow: 2</span></span>
<span id="cb65-653"><a href="#cb65-653" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: Traceplots of brms imputation model parameters.</span></span>
<span id="cb65-654"><a href="#cb65-654" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-subcap: </span></span>
<span id="cb65-655"><a href="#cb65-655" aria-hidden="true" tabindex="-1"></a><span class="in">#|   - $PPG_{jr}$ imputation model parameters</span></span>
<span id="cb65-656"><a href="#cb65-656" aria-hidden="true" tabindex="-1"></a><span class="in">#|   - $G_{jr}$ imputation model parameters</span></span>
<span id="cb65-657"><a href="#cb65-657" aria-hidden="true" tabindex="-1"></a><span class="in">plot(fit_brm_mi, variable = c("b_PPGjr", "b_Gjr"), regex = TRUE, ask = FALSE, N = 3)</span></span>
<span id="cb65-658"><a href="#cb65-658" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-659"><a href="#cb65-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-660"><a href="#cb65-660" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filename="intro-to-stan.R"}</span></span>
<span id="cb65-661"><a href="#cb65-661" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-brm-mi-cond-eff</span></span>
<span id="cb65-662"><a href="#cb65-662" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hold</span></span>
<span id="cb65-663"><a href="#cb65-663" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: The estimated conditional effects of PPG as a junior and junior-year Games played on PPG as a senior.</span></span>
<span id="cb65-664"><a href="#cb65-664" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-subcap: </span></span>
<span id="cb65-665"><a href="#cb65-665" aria-hidden="true" tabindex="-1"></a><span class="in">#|   - Estimates after MICE imputation</span></span>
<span id="cb65-666"><a href="#cb65-666" aria-hidden="true" tabindex="-1"></a><span class="in">#|   - Estimates with joint model</span></span>
<span id="cb65-667"><a href="#cb65-667" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-height: 5</span></span>
<span id="cb65-668"><a href="#cb65-668" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-width: 6</span></span>
<span id="cb65-669"><a href="#cb65-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-670"><a href="#cb65-670" aria-hidden="true" tabindex="-1"></a><span class="in">plot(brms::conditional_effects(fit_brm_mice, "PPG_jr:G_jr", resp = "PPGsr"))</span></span>
<span id="cb65-671"><a href="#cb65-671" aria-hidden="true" tabindex="-1"></a><span class="in">plot(brms::conditional_effects(fit_brm_mi, "PPG_jr:G_jr", resp = "PPGsr"))</span></span>
<span id="cb65-672"><a href="#cb65-672" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/benjamin-stockton/benjamin-stockton.github.io/edit/main/posts/intro-to-stan/intro_to_stan.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/benjamin-stockton/benjamin-stockton.github.io/blob/main/posts/intro-to-stan/intro_to_stan.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li><li><a href="https://github.com/benjamin-stockton/benjamin-stockton.github.io/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>