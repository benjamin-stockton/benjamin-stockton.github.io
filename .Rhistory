data = tmp)
smry <- summary(fit)
coef2 <- as.data.frame(smry$coefficients)
coef2$Variable <- rownames(coef2)
rownames(coef2) <- NULL
mean_Y_inc <- mean(tmp$Y)
}
else if (method == "mi") {
## Fit the MI model
# print("running mi")
tmp <- df_inc |>
select(Y, X1_inc, X2, X3, X4, X5, X6, X7)
# Impute 5 times (not enough, but a start)
imp <- mice::mice(tmp, m = 5, method = "norm",
printFlag = FALSE, maxit = 5)
fit <- with(imp, lm(Y ~ X1_inc + X2 + X3 + X4 + X5 + X6 + X7))
coef2 <- summary(pool(fit))
coef2 <- coef2 |>
mutate(
Estimate = estimate,
`Std. Error` = std.error,
`t value` = statistic,
`Pr(>|t|)` = p.value,
Variable = term
) |>
select(Estimate, `Std. Error`, `t value`, `Pr(>|t|)`, Variable)
}
coef2$true <- beta_vec[1:nrow(coef2)]
coef2$method <- method
coef <- bind_rows(coef, coef2)
}
coef$iter <- q + (i - 1) * N_sim
coef$beta1 <- beta_X1
coef$z_Y_mm <- z_mm
coef$p_miss <- p_miss
coef$mech <- mech
coef$diff_X1_mean <- mean(sim_dat$X1) - mean(df_inc$X1, na.rm = TRUE)
coef$diff_Y_mean <- mean(sim_dat$Y) - mean_Y_inc
coef$cor_pmiss_X1 <- cor(df_inc$p_miss, sim_dat$X1, use = "everything")
return(coef)
}) |>
dplyr::bind_rows()
}) |>
dplyr::bind_rows()
return(sim_res)
}
#| label: tbl-sim-settings
sim_setting <- expand.grid(
N = seq(from = 100, to = 1000, length.out = 1),
p_miss = seq(from = 0.25, to = 0.75, length.out = 5),
beta = seq(from = -5, to = 5, length.out = 5),
mech = c("MAR_MID", "MAR_TAIL", "MAR_RIGHT")
)
sim_setting |>
kableExtra::kbl(format = "markdown")
#| label: simulate
#| cache: true
#| warning: false
N_sim <- 250
start <- Sys.time()
sim_res <- simulate_lm_cca(sim_setting = sim_setting, N_sim = N_sim,
data = dat, methods = c("cca"))
#| label: single-run-fits
#| warning: false
## Complete data
df_inc <- impose_missing(sim_dat, p_miss = 0.5, mech = "MAR_RIGHT")
fit <- lm(Y ~ X1 + X2 + X3, data = sim_dat)
smry1 <- summary(fit)
# smry1
## CCA
fit <- lm(Y ~ X1_inc + X2 + X3, data = df_inc)
smry2 <- summary(fit)
# smry2
## MI
imp <- mice::mice(df_inc[, c("Y", "X1_inc", "X2", "X3", "X4", "X5", "X6", "X7")],
m = 15, maxit = 10, method = "norm", printFlag = FALSE)
#| label: single-run-fits
#| warning: false
## Complete data
df_inc <- impose_missing(sim_dat, p_miss = 0.5, mech = "MAR_RIGHT")
fit <- lm(Y ~ X1 + X2 + X3, data = sim_dat)
smry1 <- summary(fit)
# smry1
## CCA
fit <- lm(Y ~ X1_inc + X2 + X3, data = df_inc)
smry2 <- summary(fit)
# smry2
## MI
imp <- mice::mice(df_inc[, c("Y", "X1_inc", "X2", "X3")],
m = 15, maxit = 10, method = "norm", printFlag = FALSE)
fit <- with(imp, lm(Y ~ X1_inc + X2 + X3))
smry3 <- summary(pool(fit))
c("complete" = smry1$coefficients["X1", "Estimate"],
"cca" = smry2$coefficients["X1_inc", "Estimate"],
"mi" = smry3[which(smry3$term == "X1_inc"), "estimate"])
#| label: simulate-fn
simulate_lm_cca <- function(sim_setting, N_sim, data, methods = c("cca")) {
sim_res <- lapply(1:nrow(sim_setting), function(i) {
# print(paste0("Setting: ", i))
lapply(1:N_sim, function(q) {
N <- sim_setting$N[i]
mech <- sim_setting$mech[i]
beta_X1 <- sim_setting$beta[i]
beta_vec <- c(5, beta_X1, 2, 1)
p_miss <- sim_setting$p_miss[i]
## Generate data
sim_dat <- generate_data(N = N, beta = beta_vec[2:4])
## Impose Missingness
df_inc <- impose_missing(sim_dat, p_miss = p_miss, mech = mech)
# Calculate association between Y and probability X1 is missing
smry_mm <- summary(glm(R ~ Y, data = df_inc,
family = binomial(link = "logit")))
z_mm <- smry_mm$coefficients[2, 3]
## Fit Complete Data Model
fit <- lm(Y ~ X1 + X2 + X3,
data = sim_dat)
smry <- summary(fit)
coef <- as.data.frame(smry$coefficients)
coef$Variable <- rownames(coef)
coef$true <- beta_vec
rownames(coef) <- NULL
coef$method <- "complete"
for (method in methods) {
if (method == "cca") {
## Fit the CCA Model
tmp <- stats::na.omit(df_inc)
fit <- lm(Y ~ X1_inc + X2 + X3,
data = tmp)
smry <- summary(fit)
coef2 <- as.data.frame(smry$coefficients)
coef2$Variable <- rownames(coef2)
rownames(coef2) <- NULL
mean_Y_inc <- mean(tmp$Y)
}
else if (method == "mi") {
## Fit the MI model
# print("running mi")
tmp <- df_inc |>
select(Y, X1_inc, X2, X3)
# Impute 5 times (not enough, but a start)
imp <- mice::mice(tmp, m = 5, method = "norm",
printFlag = FALSE, maxit = 5)
fit <- with(imp, lm(Y ~ X1_inc + X2 + X3))
coef2 <- summary(pool(fit))
coef2 <- coef2 |>
mutate(
Estimate = estimate,
`Std. Error` = std.error,
`t value` = statistic,
`Pr(>|t|)` = p.value,
Variable = term
) |>
select(Estimate, `Std. Error`, `t value`, `Pr(>|t|)`, Variable)
}
coef2$true <- beta_vec[1:nrow(coef2)]
coef2$method <- method
coef <- bind_rows(coef, coef2)
}
coef$iter <- q + (i - 1) * N_sim
coef$beta1 <- beta_X1
coef$z_Y_mm <- z_mm
coef$p_miss <- p_miss
coef$mech <- mech
coef$diff_X1_mean <- mean(sim_dat$X1) - mean(df_inc$X1, na.rm = TRUE)
coef$diff_Y_mean <- mean(sim_dat$Y) - mean_Y_inc
coef$cor_pmiss_X1 <- cor(df_inc$p_miss, sim_dat$X1, use = "everything")
return(coef)
}) |>
dplyr::bind_rows()
}) |>
dplyr::bind_rows()
return(sim_res)
}
#| label: simulate
#| cache: true
#| warning: false
N_sim <- 250
start <- Sys.time()
sim_res <- simulate_lm_cca(sim_setting = sim_setting, N_sim = N_sim,
data = dat, methods = c("cca"))
#| label: simulate-fn
simulate_lm_cca <- function(sim_setting, N_sim, data, methods = c("cca")) {
sim_res <- lapply(1:nrow(sim_setting), function(i) {
# print(paste0("Setting: ", i))
lapply(1:N_sim, function(q) {
N <- sim_setting$N[i]
mech <- sim_setting$mech[i]
beta_X1 <- sim_setting$beta[i]
beta_vec <- c(5, beta_X1, 2, 1)
p_miss <- sim_setting$p_miss[i]
## Generate data
sim_dat <- generate_data(N = N, beta = beta_vec[2:4])
## Impose Missingness
df_inc <- impose_missing(sim_dat, p_miss = p_miss, mech = mech)
# Calculate association between Y and probability X1 is missing
smry_mm <- summary(glm(R ~ Y, data = df_inc,
family = binomial(link = "logit")))
z_mm <- smry_mm$coefficients[2, 3]
## Fit Complete Data Model
fit <- lm(Y ~ X1 + X2 + X3,
data = sim_dat)
smry <- summary(fit)
coef <- as.data.frame(smry$coefficients)
coef$Variable <- rownames(coef)
coef$true <- beta_vec
rownames(coef) <- NULL
coef$method <- "complete"
for (method in methods) {
if (method == "cca") {
## Fit the CCA Model
tmp <- stats::na.omit(df_inc)
fit <- lm(Y ~ X1_inc + X2 + X3,
data = tmp)
smry <- summary(fit)
coef2 <- as.data.frame(smry$coefficients)
coef2$Variable <- rownames(coef2)
rownames(coef2) <- NULL
mean_Y_inc <- mean(tmp$Y)
}
else if (method == "mi") {
## Fit the MI model
# print("running mi")
tmp <- df_inc |>
select(Y, X1_inc, X2, X3)
# Impute 5 times (not enough, but a start)
imp <- mice::mice(tmp, m = 5, method = "norm",
printFlag = FALSE, maxit = 5)
fit <- with(imp, lm(Y ~ X1_inc + X2 + X3))
coef2 <- summary(pool(fit))
coef2 <- coef2 |>
mutate(
Estimate = estimate,
`Std. Error` = std.error,
`t value` = statistic,
`Pr(>|t|)` = p.value,
Variable = term
) |>
select(Estimate, `Std. Error`, `t value`, `Pr(>|t|)`, Variable)
}
coef2$true <- beta_vec[1:nrow(coef2)]
coef2$method <- method
coef <- bind_rows(coef, coef2)
}
coef$iter <- q + (i - 1) * N_sim
coef$beta1 <- beta_X1
coef$z_Y_mm <- z_mm
coef$p_miss <- p_miss
coef$mech <- mech
coef$diff_X1_mean <- mean(sim_dat$X1) - mean(df_inc$X1, na.rm = TRUE)
coef$diff_Y_mean <- mean(sim_dat$Y) - mean_Y_inc
coef$cor_pmiss_X1 <- cor(df_inc$p_miss, sim_dat$X1, use = "everything")
return(coef)
}) |>
dplyr::bind_rows()
}) |>
dplyr::bind_rows()
return(sim_res)
}
#| label: simulate
#| cache: true
#| warning: false
N_sim <- 250
start <- Sys.time()
sim_res <- simulate_lm_cca(sim_setting = sim_setting, N_sim = N_sim,
data = dat, methods = c("cca"))
print(Sys.time() - start)
#| label: simulate
#| cache: true
#| warning: false
N_sim <- 250
start <- Sys.time()
sim_res <- simulate_lm_cca(sim_setting = sim_setting, N_sim = N_sim,
data = dat, methods = c("cca"))
print(Sys.time() - start)
#| label: fig-boxplot-cor
#| fig-cap: "Boxplots of the correlations between X1 and P(R=0)."
sim_res |>
mutate(
beta_label = stringr::str_c("beta_1 = ", round(beta1, 2))
) |>
filter(stringr::str_detect(Variable, "X1_inc")) |>
ggplot(aes(as.factor(round(p_miss, 2)), cor_pmiss_X1, fill = mech)) +
geom_boxplot() +
facet_wrap(beta_label~Variable, ncol = 5)
#| label: fig-boxplot-cor
#| fig-cap: "Boxplots of the correlations between X1 and P(R=0)."
sim_res |>
mutate(
beta_label = stringr::str_c("beta_1 = ", round(beta1, 2))
) |>
filter(stringr::str_detect(Variable, "X1_inc")) |>
ggplot(aes(as.factor(round(p_miss, 2)), cor_pmiss_X1, fill = mech)) +
geom_boxplot() +
facet_wrap(beta_label~Variable, ncol = 5)
#| label: sim-res
#| warning: false
sum_sim <- sim_res |>
mutate(
beta_label = stringr::str_c("beta_1 = ", round(true, 2))
) |>
filter(stringr::str_detect(Variable, "X1")) |>
group_by(Variable, method, mech, beta_label, beta1, p_miss) |>
summarize(
n = n(),
mean_est = mean(Estimate),
sd_est = sd(Estimate),
mean_bias = mean(Estimate - true),
sd_bias = sd_est,
mean_abs_bias = mean(abs(Estimate - true)),
sd_abs_bias = sd(abs(Estimate - true)),
mean_rel_bias = mean((Estimate - true) / abs(true)),
mean_se = mean(`Std. Error`),
sd_se = sd(`Std. Error`),
mse = mean((Estimate - true)^2),
sd_mse = sqrt(1/(N_sim - 1) * mean(((Estimate - true)^2 - mse)^2)),
mean_cor = mean(cor_pmiss_X1),
prop_sig_z_mm = mean(abs(z_Y_mm) > 1.96)
) |>
ungroup()
sum_sim$beta_label <- forcats::fct_reorder(sum_sim$beta_label, sum_sim$beta1)
sum_sim$method <- forcats::fct_relevel(sum_sim$method, c("complete", "cca", "mi"))
#| label: bias-plt
biasplt <- sum_sim |>
ggplot(aes(p_miss, mean_bias, color = method)) +
geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
geom_point(aes(shape = method)) +
geom_line(aes(linetype = method), alpha = 0.5) +
geom_errorbar(aes(x = p_miss,
ymin = mean_bias - 2 * sd_bias,
ymax = mean_bias + 2 * sd_bias,
color = method),
width = 0.05, alpha = 0.35) +
facet_grid(mech ~ beta_label, scales = "free") +
theme(legend.position = "bottom")
mseplt <- sum_sim |>
ggplot(aes(p_miss, mse, color = method)) +
geom_point(aes(shape = method)) +
geom_line(aes(linetype = method), alpha = 0.5) +
geom_errorbar(aes(x = p_miss,
ymin = mse - 2 * sd_mse,
ymax = mse + 2 * sd_mse,
color = method),
width = 0.05, alpha = 0.35) +
facet_grid(mech ~ beta_label, scales = "free") +
theme(legend.position = "bottom")
#| label: fig-sim-res
#| fig-cap: Simulation results.
#| fig-subcap: true
biasplt
mseplt
sim_dat |>
ggplot(aes(Y, p_miss_MID)) +
geom_line() +
geom_line(aes(Y, p_miss_TAIL), color = "tomato", linetype = "dotted") +
geom_line(aes(Y, p_miss_RIGHT), color = "dodgerblue", linetype = "dashed") +
annotate(geom = "text", x = 11, y = 0.5,
label = "MAR MID")
sim_dat |>
ggplot(aes(Y, p_miss_MID)) +
geom_line() +
geom_line(aes(Y, p_miss_TAIL), color = "tomato", linetype = "dotted") +
geom_line(aes(Y, p_miss_RIGHT), color = "dodgerblue", linetype = "dashed") +
annotate(geom = "text", x = 11, y = 0.5,
label = "MAR MID") +
annotate(geom = "text", x = 4, y = 0.5,
label = "MAR TAIL",
color = "tomato")
sim_dat |>
ggplot(aes(Y, p_miss_MID)) +
geom_line() +
geom_line(aes(Y, p_miss_TAIL), color = "tomato", linetype = "dotted") +
geom_line(aes(Y, p_miss_RIGHT), color = "dodgerblue", linetype = "dashed") +
annotate(geom = "text", x = 11, y = 0.5,
label = "MAR MID") +
annotate(geom = "text", x = 2, y = 0.5,
label = "MAR TAIL",
color = "tomato")
sim_dat |>
ggplot(aes(Y, p_miss_MID)) +
geom_line() +
geom_line(aes(Y, p_miss_TAIL), color = "tomato", linetype = "dotted") +
geom_line(aes(Y, p_miss_RIGHT), color = "dodgerblue", linetype = "dashed") +
annotate(geom = "text", x = 11, y = 0.5,
label = "MAR MID") +
annotate(geom = "text", x = 0, y = 0.5,
label = "MAR TAIL",
color = "tomato")
sim_dat |>
ggplot(aes(Y, p_miss_MID)) +
geom_line() +
geom_line(aes(Y, p_miss_TAIL), color = "tomato", linetype = "dotted") +
geom_line(aes(Y, p_miss_RIGHT), color = "dodgerblue", linetype = "dashed") +
annotate(geom = "text", x = 11, y = 0.5,
label = "MAR MID") +
annotate(geom = "text", x = -1, y = 0.5,
label = "MAR TAIL",
color = "tomato")
sim_dat |>
ggplot(aes(Y, p_miss_MID)) +
geom_line() +
geom_line(aes(Y, p_miss_TAIL), color = "tomato", linetype = "dotted") +
geom_line(aes(Y, p_miss_RIGHT), color = "dodgerblue", linetype = "dashed") +
annotate(geom = "text", x = 11, y = 0.5,
label = "MAR MID") +
annotate(geom = "text", x = -1, y = 0.5,
label = "MAR TAIL",
color = "tomato") +
annotate(geom = "text", x = 7, y = 0.5,
label = "MAR RIGHT",
color = "dodgerblue")
sim_dat |>
ggplot(aes(Y, p_miss_MID)) +
geom_line() +
geom_line(aes(Y, p_miss_TAIL), color = "tomato", linetype = "dotted") +
geom_line(aes(Y, p_miss_RIGHT), color = "dodgerblue", linetype = "dashed") +
annotate(geom = "text", x = 11, y = 0.7,
label = "MAR MID") +
annotate(geom = "text", x = -1, y = 0.5,
label = "MAR TAIL",
color = "tomato") +
annotate(geom = "text", x = 7, y = 0.5,
label = "MAR RIGHT",
color = "dodgerblue")
sim_dat |>
ggplot(aes(Y, p_miss_MID)) +
geom_line() +
geom_line(aes(Y, p_miss_TAIL), color = "tomato", linetype = "dotted") +
geom_line(aes(Y, p_miss_RIGHT), color = "dodgerblue", linetype = "dashed") +
annotate(geom = "text", x = 9, y = 0.7,
label = "MAR MID") +
annotate(geom = "text", x = -1, y = 0.5,
label = "MAR TAIL",
color = "tomato") +
annotate(geom = "text", x = 8, y = 0.5,
label = "MAR RIGHT",
color = "dodgerblue")
sim_dat |>
ggplot(aes(Y, p_miss_MID)) +
geom_line() +
geom_line(aes(Y, p_miss_TAIL), color = "tomato", linetype = "dotted") +
geom_line(aes(Y, p_miss_RIGHT), color = "dodgerblue", linetype = "dashed") +
annotate(geom = "text", x = 10, y = 0.7,
label = "MAR MID") +
annotate(geom = "text", x = -1, y = 0.5,
label = "MAR TAIL",
color = "tomato") +
annotate(geom = "text", x = 8, y = 0.5,
label = "MAR RIGHT",
color = "dodgerblue")
sim_dat |>
ggplot(aes(Y, p_miss_MID)) +
geom_line() +
geom_line(aes(Y, p_miss_TAIL), color = "tomato", linetype = "dotted") +
geom_line(aes(Y, p_miss_RIGHT), color = "dodgerblue", linetype = "dashed") +
annotate(geom = "text", x = 10, y = 0.7,
label = "MAR MID") +
annotate(geom = "text", x = -1, y = 0.5,
label = "MAR TAIL",
color = "tomato") +
annotate(geom = "text", x = 7, y = 0.25,
label = "MAR RIGHT",
color = "dodgerblue")
#| label: fig-boxplot-cor
#| fig-cap: "Boxplots of the correlations between X1 and P(R=0)."
sim_res |>
mutate(
beta_label = stringr::str_c("beta_1 = ", round(beta1, 2))
) |>
filter(stringr::str_detect(Variable, "X1_inc")) |>
ggplot(aes(as.factor(round(p_miss, 2)), cor_pmiss_X1, fill = mech)) +
geom_boxplot() +
facet_wrap(beta_label~Variable, ncol = 5) +
labs(x = latex2exp::TeX("$p_{miss}$"),
y = latex2exp::TeX("$cor(p_{miss}, X_1)$"))
#| label: fig-boxplot-cor
#| fig-cap: "Boxplots of the correlations between X1 and P(R=0)."
sim_res |>
mutate(
beta_label = stringr::str_c("beta_1 = ", round(beta1, 2))
) |>
filter(stringr::str_detect(Variable, "X1_inc")) |>
ggplot(aes(as.factor(round(p_miss, 2)), cor_pmiss_X1, fill = mech)) +
geom_boxplot() +
facet_wrap(beta_label~Variable, ncol = 5,
labeller = label_parsed) +
labs(x = latex2exp::TeX("$p_{miss}$"),
y = latex2exp::TeX("$cor(p_{miss}, X_1)$"))
#| label: fig-boxplot-cor
#| fig-cap: "Boxplots of the correlations between X1 and P(R=0)."
sim_res |>
mutate(
beta_label = stringr::str_c("beta_1 = ", round(beta1, 2))
) |>
filter(stringr::str_detect(Variable, "X1_inc")) |>
ggplot(aes(as.factor(round(p_miss, 2)), cor_pmiss_X1, fill = mech)) +
geom_boxplot() +
facet_wrap(beta_label~Variable, ncol = 5) +
labs(x = latex2exp::TeX("$p_{miss}$"),
y = latex2exp::TeX("$cor(p_{miss}, X_1)$"))
#| label: fig-boxplot-cor
#| fig-cap: "Boxplots of the correlations between X1 and P(R=0)."
sim_res |>
mutate(
beta_label = stringr::str_c("beta_1 = ", round(beta1, 2))
) |>
filter(stringr::str_detect(Variable, "X1_inc")) |>
ggplot(aes(as.factor(round(p_miss, 2)), cor_pmiss_X1, fill = mech)) +
geom_boxplot() +
facet_wrap(beta_label~Variable, ncol = 5) +
theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
labs(x = latex2exp::TeX("$p_{miss}$"),
y = latex2exp::TeX("$cor(p_{miss}, X_1)$"))
